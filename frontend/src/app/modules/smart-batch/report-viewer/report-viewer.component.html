<div class="min-h-screen w-full bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button
                        mat-icon-button
                        (click)="goBack()"
                        [matTooltip]="'smartReport.back' | transloco"
                    >
                        <mat-icon>arrow_back</mat-icon>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">
                            {{ 'smartReport.generateReport' | transloco }}
                        </h1>
                        <p class="text-sm text-gray-500">
                            {{ batch()?.name || ('smartReport.batchReport' | transloco) }}
                        </p>
                    </div>
                </div>

                <button mat-stroked-button (click)="openReportBuilder(true)" class="!rounded-xl">
                    <mat-icon class="mr-2">design_services</mat-icon>
                    {{ 'smartReport.createTemplate' | transloco }}
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="w-full px-4 sm:px-6 lg:px-8 py-6">
        @if (isLoading()) {
            <div class="flex items-center justify-center h-64">
                <mat-spinner diameter="48"></mat-spinner>
            </div>
        } @else {
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Template Selection (unified: template list + match status + edit action) -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                        <div class="p-6">
                            <h3 class="font-semibold text-gray-900 mb-4">
                                {{ 'smartReport.selectTemplate' | transloco }}
                            </h3>

                            @if (templates().length === 0) {
                                <div class="text-center py-8 text-gray-400">
                                    <mat-icon class="!text-4xl !w-10 !h-10 mb-2"
                                        >description</mat-icon
                                    >
                                    <p class="text-sm">
                                        {{ 'smartReport.noTemplatesFound' | transloco }}
                                    </p>
                                    <button
                                        mat-flat-button
                                        color="primary"
                                        class="mt-4 !rounded-xl !bg-indigo-600"
                                        (click)="openReportBuilder(true)"
                                    >
                                        {{ 'smartReport.createTemplate' | transloco }}
                                    </button>
                                </div>
                            } @else {
                                <div class="space-y-2 max-h-[320px] overflow-y-auto pr-1">
                                    @for (template of templates(); track template._id) {
                                        <div
                                            class="p-4 rounded-xl border cursor-pointer transition-all"
                                            [class.border-indigo-500]="
                                                selectedTemplate()?._id === template._id
                                            "
                                            [class.bg-indigo-50]="
                                                selectedTemplate()?._id === template._id
                                            "
                                            [class.border-gray-200]="
                                                selectedTemplate()?._id !== template._id
                                            "
                                            [class.hover:border-indigo-300]="
                                                selectedTemplate()?._id !== template._id
                                            "
                                            (click)="selectTemplate(template)"
                                        >
                                            <div class="flex items-center gap-3">
                                                <div
                                                    class="w-10 h-10 rounded-xl flex items-center justify-center shrink-0"
                                                    [style.background]="
                                                        (template.primaryColor || '#4F46E5') + '20'
                                                    "
                                                >
                                                    <mat-icon
                                                        [style.color]="
                                                            template.primaryColor || '#4F46E5'
                                                        "
                                                    >
                                                        description
                                                    </mat-icon>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="font-medium text-gray-900">
                                                        {{ template.name }}
                                                    </p>
                                                    <p class="text-xs text-gray-500">
                                                        {{ template.sections?.length || 0 }}
                                                        {{ 'smartReport.sections' | transloco }} •
                                                        {{ template.pdfEngine || 'puppeteer' }}
                                                    </p>
                                                    @if (
                                                        selectedTemplate()?._id === template._id &&
                                                            templateMatch();
                                                        as match
                                                    ) {
                                                        @if (match.matches) {
                                                            <span
                                                                class="inline-flex items-center gap-1 mt-1 text-xs text-emerald-600"
                                                            >
                                                                <mat-icon
                                                                    class="!text-sm !w-3.5 !h-3.5"
                                                                    >check_circle</mat-icon
                                                                >
                                                                {{
                                                                    'smartReport.templateMatchesData'
                                                                        | transloco
                                                                }}
                                                            </span>
                                                        } @else if (match.missingPaths.length > 0) {
                                                            <span
                                                                class="inline-flex items-center gap-1 mt-1 text-xs text-amber-600"
                                                                [matTooltip]="
                                                                    ('smartReport.paths'
                                                                        | transloco) +
                                                                    ': ' +
                                                                    formatMissingPaths(
                                                                        match.missingPaths
                                                                    )
                                                                "
                                                            >
                                                                <mat-icon
                                                                    class="!text-sm !w-3.5 !h-3.5"
                                                                    >warning</mat-icon
                                                                >
                                                                {{
                                                                    'smartReport.missingFields'
                                                                        | transloco
                                                                            : {
                                                                                  count: match
                                                                                      .missingPaths
                                                                                      .length,
                                                                              }
                                                                }}
                                                            </span>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Unified: match status + edit-in-builder (single footer) -->
                        @if (selectedTemplate() && templateMatch(); as match) {
                            <div
                                class="border-t border-gray-100 px-6 py-4"
                                [class.bg-emerald-50]="match.matches"
                                [class.bg-amber-50]="!match.matches"
                            >
                                @if (match.matches) {
                                    <p class="text-sm text-emerald-700 mb-3 flex items-start gap-2">
                                        <mat-icon class="!text-lg !w-5 !h-5 shrink-0 mt-0.5"
                                            >check_circle</mat-icon
                                        >
                                        <span>{{
                                            'smartReport.templateReadyToUse' | transloco
                                        }}</span>
                                    </p>
                                    <button
                                        mat-stroked-button
                                        (click)="openReportBuilder()"
                                        class="!rounded-xl !text-emerald-700 !border-emerald-300 !inline-flex !items-center !justify-center"
                                    >
                                        <mat-icon class="mr-2 !text-lg !align-middle"
                                            >edit</mat-icon
                                        >
                                        {{ 'smartReport.editInBuilder' | transloco }}
                                    </button>
                                } @else {
                                    <p class="text-sm text-amber-700 mb-2 flex items-start gap-2">
                                        <mat-icon class="!text-lg !w-5 !h-5 shrink-0 mt-0.5"
                                            >warning</mat-icon
                                        >
                                        <span>{{
                                            'smartReport.missingFieldsEditInBuilder'
                                                | transloco: { count: match.missingPaths.length }
                                        }}</span>
                                    </p>
                                    <p class="text-xs text-amber-600/80 mb-3 pl-7">
                                        {{ 'smartReport.paths' | transloco }}:
                                        {{ formatMissingPaths(match.missingPaths) }}
                                    </p>
                                    <button
                                        mat-stroked-button
                                        (click)="openReportBuilder()"
                                        class="!rounded-xl !text-amber-700 !border-amber-300 !inline-flex !items-center !justify-center"
                                    >
                                        <mat-icon class="mr-2 !text-lg !align-middle"
                                            >edit</mat-icon
                                        >
                                        {{ 'smartReport.editInBuilder' | transloco }}
                                    </button>
                                }
                            </div>
                        }
                    </div>

                    <!-- Actions -->
                    @if (selectedTemplate() || stepResultBlocks().length > 0) {
                        <div class="bg-white rounded-2xl border border-gray-200 p-6 mt-6">
                            <h3 class="font-semibold text-gray-900 mb-4">
                                {{ 'smartReport.actions' | transloco }}
                            </h3>
                            <div class="space-y-3">
                                @if (selectedTemplate()) {
                                    <button
                                        mat-flat-button
                                        color="primary"
                                        (click)="generateReport()"
                                        [disabled]="isGenerating()"
                                        class="w-full !rounded-xl !bg-indigo-600 !inline-flex !items-center !justify-center"
                                    >
                                        @if (isGenerating()) {
                                            <mat-icon class="animate-spin mr-2 !align-middle"
                                                >refresh</mat-icon
                                            >
                                            {{ 'smartReport.generating' | transloco }}
                                        } @else {
                                            {{ 'smartReport.generatePdf' | transloco }}
                                        }
                                    </button>

                                    @if (report()) {
                                        <button
                                            mat-stroked-button
                                            (click)="downloadReport()"
                                            class="w-full !rounded-xl !inline-flex !items-center !justify-center"
                                        >
                                            <mat-icon class="mr-2 !align-middle">download</mat-icon>
                                            {{ 'smartReport.downloadPdf' | transloco }}
                                        </button>

                                        <button
                                            mat-stroked-button
                                            (click)="sendEmail()"
                                            [disabled]="isSending()"
                                            class="w-full !rounded-xl !inline-flex !items-center !justify-center"
                                        >
                                            @if (isSending()) {
                                                <mat-icon class="animate-spin mr-2 !align-middle"
                                                    >refresh</mat-icon
                                                >
                                                {{ 'smartReport.sending' | transloco }}
                                            } @else {
                                                {{ 'smartReport.sendViaEmail' | transloco }}
                                            }
                                        </button>
                                    }
                                }

                                <!-- Data Export -->
                                @if (stepResultBlocks().length > 0) {
                                    <div
                                        class="pt-3"
                                        [class.border-t]="selectedTemplate()"
                                        [class.border-gray-100]="selectedTemplate()"
                                        [class.mt-3]="selectedTemplate()"
                                    >
                                        <p class="text-xs text-gray-500 mb-2 uppercase font-medium">
                                            {{ 'smartReport.exportData' | transloco }}
                                        </p>
                                        <div class="space-y-2">
                                            <button
                                                mat-stroked-button
                                                (click)="downloadAsCsv()"
                                                class="w-full !rounded-xl !inline-flex !items-center !justify-center"
                                            >
                                                <mat-icon class="mr-2 !align-middle"
                                                    >download</mat-icon
                                                >
                                                {{ 'smartReport.downloadAsCsv' | transloco }}
                                            </button>
                                            <button
                                                mat-stroked-button
                                                (click)="downloadAsExcel()"
                                                class="w-full !rounded-xl !inline-flex !items-center !justify-center"
                                            >
                                                <mat-icon class="mr-2 !align-middle"
                                                    >table_chart</mat-icon
                                                >
                                                {{ 'smartReport.downloadAsExcel' | transloco }}
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Right column: Step results layout + PDF Preview -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Step results layout (print-style, drag-and-drop) -->
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h3 class="font-semibold text-gray-900">
                                        {{ 'smartReport.stepResultsLayout' | transloco }}
                                    </h3>
                                    <p class="text-xs text-gray-500 mt-0.5">
                                        @if (selectedRowIndex() != null) {
                                            {{
                                                'smartReport.reportForRecord'
                                                    | transloco: { index: selectedRowIndex()! + 1 }
                                            }}
                                        } @else {
                                            {{ 'smartReport.dragSectionsReorder' | transloco }}
                                        }
                                    </p>
                                </div>
                                <div class="flex items-center gap-2">
                                    @if (stepResultBlocks().length > 0) {
                                        <mat-button-toggle-group
                                            [value]="stepResultsViewMode()"
                                            (change)="stepResultsViewMode.set($event.value)"
                                            class="!rounded-lg"
                                        >
                                            <mat-button-toggle value="table">
                                                {{ 'smartReport.viewModeTable' | transloco }}
                                            </mat-button-toggle>
                                            <mat-button-toggle value="json">
                                                {{ 'smartReport.viewModeJson' | transloco }}
                                            </mat-button-toggle>
                                            <mat-button-toggle value="excel-ag">
                                                {{ 'smartReport.viewModeExcelAg' | transloco }}
                                            </mat-button-toggle>
                                            <mat-button-toggle value="excel-ht">
                                                {{ 'smartReport.viewModeExcelHt' | transloco }}
                                            </mat-button-toggle>
                                        </mat-button-toggle-group>
                                    }
                                    <button
                                        mat-icon-button
                                        (click)="toggleStepResultsContent()"
                                        [matTooltip]="
                                            stepResultsContentExpanded()
                                                ? ('smartReport.collapseContent' | transloco)
                                                : ('smartReport.expandContent' | transloco)
                                        "
                                        class="!w-8 !h-8"
                                    >
                                        <mat-icon class="!text-lg">{{
                                            stepResultsContentExpanded()
                                                ? 'expand_more'
                                                : 'expand_less'
                                        }}</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                        @if (stepResultsContentExpanded()) {
                            <div class="p-6">
                                @if (stepResultBlocks().length === 0) {
                                    <div
                                        class="flex flex-col items-center justify-center py-12 text-gray-400"
                                    >
                                        <mat-icon class="!text-5xl !w-12 !h-12 mb-3"
                                            >table_chart</mat-icon
                                        >
                                        <p class="text-sm font-medium">
                                            {{ 'smartReport.noStepResultsYet' | transloco }}
                                        </p>
                                        <p class="text-xs mt-1">
                                            {{ 'smartReport.processBatchToSeeResults' | transloco }}
                                        </p>
                                    </div>
                                } @else {
                                    @if (stepResultsViewMode() === 'excel-ag') {
                                        <!-- Excel view: AG Grid -->
                                        <div
                                            class="excel-view-container mx-auto rounded-xl overflow-hidden"
                                            style="height: 480px; width: 100%"
                                        >
                                            <ag-grid-angular
                                                class="ag-theme-quartz"
                                                style="width: 100%; height: 100%"
                                                [rowData]="gridRowData()"
                                                [columnDefs]="gridColumnDefs()"
                                                [defaultColDef]="{
                                                    sortable: true,
                                                    resizable: true,
                                                    filter: true,
                                                }"
                                                [rowHeight]="44"
                                                [headerHeight]="44"
                                                [suppressRowClickSelection]="true"
                                                [domLayout]="'normal'"
                                            />
                                        </div>
                                    } @else if (stepResultsViewMode() === 'excel-ht') {
                                        <!-- Excel view: Handsontable (non-commercial) -->
                                        <div
                                            class="excel-view-container mx-auto rounded-xl overflow-hidden"
                                            style="height: 480px; width: 100%"
                                        >
                                            <hot-table
                                                [data]="handsontableData()"
                                                [settings]="handsontableSettings()"
                                            />
                                        </div>
                                    } @else {
                                        <!-- Table or JSON view: record-grouped layout (like PDF preview) -->
                                        <div
                                            class="mb-4 bg-white rounded-lg border border-gray-200 overflow-hidden flex flex-col sm:flex-row items-center justify-between p-2 pl-4"
                                        >
                                            <mat-form-field
                                                appearance="outline"
                                                subscriptSizing="dynamic"
                                                class="w-full sm:w-72"
                                            >
                                                <mat-icon matPrefix class="text-gray-400 mr-2"
                                                    >search</mat-icon
                                                >
                                                <mat-label>Search records...</mat-label>
                                                <input
                                                    matInput
                                                    [ngModel]="searchQuery()"
                                                    (ngModelChange)="updateSearchQuery($event)"
                                                    placeholder="Type to find..."
                                                />
                                                <button
                                                    mat-icon-button
                                                    matSuffix
                                                    *ngIf="searchQuery()"
                                                    (click)="updateSearchQuery('')"
                                                >
                                                    <mat-icon>close</mat-icon>
                                                </button>
                                            </mat-form-field>

                                            <mat-paginator
                                                class="!bg-transparent flex-1 justify-end"
                                                [length]="totalRecords()"
                                                [pageSize]="pageSize()"
                                                [pageSizeOptions]="[5, 10, 25, 100]"
                                                (page)="handlePageEvent($event)"
                                                [showFirstLastButtons]="true"
                                            ></mat-paginator>
                                        </div>
                                        <div
                                            class="mx-auto bg-[#fafafa] rounded-lg border border-gray-200 shadow-sm p-6 min-h-[400px]"
                                        >
                                            <div class="space-y-4">
                                                @for (
                                                    recordBlock of recordResultBlocks();
                                                    track recordBlock.rowIndex
                                                ) {
                                                    <div
                                                        class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
                                                    >
                                                        <div
                                                            class="flex items-center gap-3 px-4 py-2.5 border-b border-gray-100 bg-gray-50"
                                                        >
                                                            <mat-icon
                                                                class="!text-base text-gray-400"
                                                                >person</mat-icon
                                                            >
                                                            <span class="font-medium text-gray-900">
                                                                {{ 'smartReport.row' | transloco }}
                                                                #{{ recordBlock.rowIndex + 1 }}
                                                            </span>
                                                        </div>
                                                        @if (stepResultsViewMode() === 'table') {
                                                            <!-- Table view: steps per record -->
                                                            <div
                                                                class="px-4 py-3 bg-white border-t border-gray-100 overflow-x-auto"
                                                            >
                                                                @for (
                                                                    step of recordBlock.steps;
                                                                    track step.sequence
                                                                ) {
                                                                    <div class="mb-4 last:mb-0">
                                                                        <p
                                                                            class="text-xs font-medium text-gray-500 mb-2"
                                                                        >
                                                                            {{ step.label }}
                                                                            <span
                                                                                class="text-gray-400"
                                                                                >({{
                                                                                    'smartReport.step'
                                                                                        | transloco
                                                                                }}
                                                                                {{
                                                                                    step.sequence
                                                                                }})</span
                                                                            >
                                                                        </p>
                                                                        @if (step.data != null) {
                                                                            <table
                                                                                class="w-full text-sm border-collapse"
                                                                            >
                                                                                <tbody>
                                                                                    @for (
                                                                                        field of getStepResultFields(
                                                                                            step.data
                                                                                        );
                                                                                        track field.label
                                                                                    ) {
                                                                                        <tr
                                                                                            class="border-b border-gray-100 last:border-0"
                                                                                        >
                                                                                            <td
                                                                                                class="py-2 pr-4 align-top text-gray-500"
                                                                                                style="
                                                                                                    min-width: 140px;
                                                                                                "
                                                                                            >
                                                                                                {{
                                                                                                    field.label
                                                                                                }}
                                                                                            </td>
                                                                                            <td
                                                                                                class="py-2 break-words text-gray-900"
                                                                                            >
                                                                                                {{
                                                                                                    field.value
                                                                                                }}
                                                                                            </td>
                                                                                        </tr>
                                                                                    }
                                                                                </tbody>
                                                                            </table>
                                                                        } @else {
                                                                            <p
                                                                                class="text-sm text-gray-400 py-2"
                                                                            >
                                                                                —
                                                                            </p>
                                                                        }
                                                                    </div>
                                                                }
                                                            </div>
                                                        } @else {
                                                            <!-- JSON view: steps per record -->
                                                            <div
                                                                class="px-4 py-3 bg-white border-t border-gray-100 overflow-x-auto"
                                                            >
                                                                @for (
                                                                    step of recordBlock.steps;
                                                                    track step.sequence
                                                                ) {
                                                                    <div
                                                                        class="border-b border-gray-100 last:border-0 pb-3 last:pb-0 mb-3 last:mb-0"
                                                                    >
                                                                        <p
                                                                            class="text-xs font-medium text-gray-500 mb-2"
                                                                        >
                                                                            {{ step.label }}
                                                                            <span
                                                                                class="text-gray-400"
                                                                                >({{
                                                                                    'smartReport.step'
                                                                                        | transloco
                                                                                }}
                                                                                {{
                                                                                    step.sequence
                                                                                }})</span
                                                                            >
                                                                        </p>
                                                                        <pre
                                                                            class="bg-gray-50 rounded-lg p-3 text-xs font-mono text-gray-800 overflow-auto max-h-64"
                                                                            >{{
                                                                                formatJson(
                                                                                    step.data
                                                                                )
                                                                            }}</pre
                                                                        >
                                                                    </div>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>

                    <!-- Report Preview (same as builder) -->
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                            <h3 class="font-semibold text-gray-900">
                                {{ 'smartReport.preview' | transloco }}
                            </h3>
                            <p class="text-xs text-gray-500 mt-0.5">
                                {{ 'smartReport.previewSameAsBuilder' | transloco }}
                            </p>
                        </div>

                        <div class="min-h-[600px] p-6 overflow-auto">
                            @if (isGenerating()) {
                                <div
                                    class="flex flex-col items-center justify-center h-64 text-gray-400"
                                >
                                    <mat-spinner diameter="48" class="mb-4"></mat-spinner>
                                    <p>{{ 'smartReport.generatingPdf' | transloco }}</p>
                                </div>
                            } @else if (selectedTemplate() && batch()?.rows?.length) {
                                <report-preview
                                    [template]="selectedTemplate()!"
                                    [previewData]="previewDataForCurrentPage()"
                                    [primaryColor]="selectedTemplate()!.primaryColor || '#4F46E5'"
                                    [orientation]="'portrait'"
                                    [clickable]="false"
                                />
                                @if (previewDataForAllRows().length > 1) {
                                    <div
                                        class="flex items-center justify-center gap-4 mt-6 pt-4 border-t border-gray-200"
                                    >
                                        <button
                                            mat-icon-button
                                            (click)="goToPreviewPage(previewPageIndex() - 1)"
                                            [disabled]="previewPageIndex() <= 0"
                                            [matTooltip]="'smartReport.previewPrevious' | transloco"
                                        >
                                            <mat-icon>chevron_left</mat-icon>
                                        </button>
                                        <span class="text-sm text-gray-600">
                                            {{ 'smartReport.previewPage' | transloco }}
                                            {{ previewPageIndex() + 1 }}
                                            {{ 'smartReport.previewPageOf' | transloco }}
                                            {{ previewDataForAllRows().length }}
                                        </span>
                                        <button
                                            mat-icon-button
                                            (click)="goToPreviewPage(previewPageIndex() + 1)"
                                            [disabled]="
                                                previewPageIndex() >=
                                                previewDataForAllRows().length - 1
                                            "
                                            [matTooltip]="'smartReport.previewNext' | transloco"
                                        >
                                            <mat-icon>chevron_right</mat-icon>
                                        </button>
                                    </div>
                                }
                            } @else {
                                <div
                                    class="flex flex-col items-center justify-center h-64 text-gray-400"
                                >
                                    <mat-icon class="!text-6xl !w-16 !h-16 mb-4"
                                        >description</mat-icon
                                    >
                                    <p class="text-lg mb-2">
                                        {{ 'smartReport.noPreviewAvailable' | transloco }}
                                    </p>
                                    <p class="text-sm">
                                        {{ 'smartReport.selectTemplateAndBatch' | transloco }}
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
