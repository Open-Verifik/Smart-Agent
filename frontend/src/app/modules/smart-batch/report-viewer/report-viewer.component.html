<div class="min-h-screen w-full bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button mat-icon-button (click)="goBack()" [matTooltip]="'smartReport.back' | transloco">
                        <mat-icon>arrow_back</mat-icon>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">{{ 'smartReport.generateReport' | transloco }}</h1>
                        <p class="text-sm text-gray-500">{{ batch()?.name || ('smartReport.batchReport' | transloco) }}</p>
                    </div>
                </div>

                <button mat-stroked-button (click)="openReportBuilder(true)" class="!rounded-xl">
                    <mat-icon class="mr-2">design_services</mat-icon>
                    {{ 'smartReport.createTemplate' | transloco }}
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="w-full px-4 sm:px-6 lg:px-8 py-6">
        @if (isLoading()) {
            <div class="flex items-center justify-center h-64">
                <mat-spinner diameter="48"></mat-spinner>
            </div>
        } @else {
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Template Selection (unified: template list + match status + edit action) -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                        <div class="p-6">
                            <h3 class="font-semibold text-gray-900 mb-4">{{ 'smartReport.selectTemplate' | transloco }}</h3>

                            @if (templates().length === 0) {
                                <div class="text-center py-8 text-gray-400">
                                    <mat-icon class="!text-4xl !w-10 !h-10 mb-2">description</mat-icon>
                                    <p class="text-sm">{{ 'smartReport.noTemplatesFound' | transloco }}</p>
                                    <button
                                        mat-flat-button
                                        color="primary"
                                        class="mt-4 !rounded-xl !bg-indigo-600"
                                        (click)="openReportBuilder(true)"
                                    >
                                        {{ 'smartReport.createTemplate' | transloco }}
                                    </button>
                                </div>
                            } @else {
                                <div class="space-y-2 max-h-[320px] overflow-y-auto pr-1">
                                    @for (template of templates(); track template._id) {
                                        <div
                                            class="p-4 rounded-xl border cursor-pointer transition-all"
                                            [class.border-indigo-500]="
                                                selectedTemplate()?._id === template._id
                                            "
                                            [class.bg-indigo-50]="
                                                selectedTemplate()?._id === template._id
                                            "
                                            [class.border-gray-200]="
                                                selectedTemplate()?._id !== template._id
                                            "
                                            [class.hover:border-indigo-300]="
                                                selectedTemplate()?._id !== template._id
                                            "
                                            (click)="selectTemplate(template)"
                                        >
                                            <div class="flex items-center gap-3">
                                                <div
                                                    class="w-10 h-10 rounded-xl flex items-center justify-center shrink-0"
                                                    [style.background]="
                                                        (template.primaryColor || '#4F46E5') + '20'
                                                    "
                                                >
                                                    <mat-icon
                                                        [style.color]="
                                                            template.primaryColor || '#4F46E5'
                                                        "
                                                    >
                                                        description
                                                    </mat-icon>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="font-medium text-gray-900">
                                                        {{ template.name }}
                                                    </p>
                                                    <p class="text-xs text-gray-500">
                                                        {{ template.sections?.length || 0 }} {{ 'smartReport.sections' | transloco }} •
                                                        {{ template.pdfEngine || 'puppeteer' }}
                                                    </p>
                                                    @if (
                                                        selectedTemplate()?._id === template._id &&
                                                            templateMatch();
                                                        as match
                                                    ) {
                                                        @if (match.matches) {
                                                            <span class="inline-flex items-center gap-1 mt-1 text-xs text-emerald-600">
                                                                <mat-icon class="!text-sm !w-3.5 !h-3.5">check_circle</mat-icon>
                                                                {{ 'smartReport.templateMatchesData' | transloco }}
                                                            </span>
                                                        } @else if (match.missingPaths.length > 0) {
                                                            <span
                                                                class="inline-flex items-center gap-1 mt-1 text-xs text-amber-600"
                                                                [matTooltip]="
                                                                    ('smartReport.paths' | transloco) + ': ' +
                                                                    formatMissingPaths(match.missingPaths)
                                                                "
                                                            >
                                                                <mat-icon class="!text-sm !w-3.5 !h-3.5">warning</mat-icon>
                                                                {{ 'smartReport.missingFields' | transloco: { count: match.missingPaths.length } }}
                                                            </span>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Unified: match status + edit-in-builder (single footer) -->
                        @if (selectedTemplate() && templateMatch(); as match) {
                            <div
                                class="border-t border-gray-100 px-6 py-4"
                                [class.bg-emerald-50]="match.matches"
                                [class.bg-amber-50]="!match.matches"
                            >
                                @if (match.matches) {
                                    <p class="text-sm text-emerald-700 mb-3 flex items-start gap-2">
                                        <mat-icon class="!text-lg !w-5 !h-5 shrink-0 mt-0.5">check_circle</mat-icon>
                                        <span>{{ 'smartReport.templateReadyToUse' | transloco }}</span>
                                    </p>
                                    <button
                                        mat-stroked-button
                                        (click)="openReportBuilder()"
                                        class="!rounded-xl !text-emerald-700 !border-emerald-300 !inline-flex !items-center !justify-center"
                                    >
                                        <mat-icon class="mr-2 !text-lg !align-middle">edit</mat-icon>
                                        {{ 'smartReport.editInBuilder' | transloco }}
                                    </button>
                                } @else {
                                    <p class="text-sm text-amber-700 mb-2 flex items-start gap-2">
                                        <mat-icon class="!text-lg !w-5 !h-5 shrink-0 mt-0.5">warning</mat-icon>
                                        <span>{{ 'smartReport.missingFieldsEditInBuilder' | transloco: { count: match.missingPaths.length } }}</span>
                                    </p>
                                    <p class="text-xs text-amber-600/80 mb-3 pl-7">
                                        {{ 'smartReport.paths' | transloco }}: {{ formatMissingPaths(match.missingPaths) }}
                                    </p>
                                    <button
                                        mat-stroked-button
                                        (click)="openReportBuilder()"
                                        class="!rounded-xl !text-amber-700 !border-amber-300 !inline-flex !items-center !justify-center"
                                    >
                                        <mat-icon class="mr-2 !text-lg !align-middle">edit</mat-icon>
                                        {{ 'smartReport.editInBuilder' | transloco }}
                                    </button>
                                }
                            </div>
                        }
                    </div>

                    <!-- Actions -->
                    @if (selectedTemplate()) {
                        <div class="bg-white rounded-2xl border border-gray-200 p-6 mt-6">
                            <h3 class="font-semibold text-gray-900 mb-4">{{ 'smartReport.actions' | transloco }}</h3>
                            <div class="space-y-3">
                                <button
                                    mat-flat-button
                                    color="primary"
                                    (click)="generateReport()"
                                    [disabled]="isGenerating()"
                                    class="w-full !rounded-xl !bg-indigo-600 !inline-flex !items-center !justify-center"
                                >
                                    @if (isGenerating()) {
                                        <mat-icon class="animate-spin mr-2 !align-middle"
                                            >refresh</mat-icon
                                        >
                                        {{ 'smartReport.generating' | transloco }}
                                    } @else {
                                        {{ 'smartReport.generatePdf' | transloco }}
                                    }
                                </button>

                                @if (report()) {
                                    <button
                                        mat-stroked-button
                                        (click)="downloadReport()"
                                        class="w-full !rounded-xl !inline-flex !items-center !justify-center"
                                    >
                                        <mat-icon class="mr-2 !align-middle">download</mat-icon>
                                        {{ 'smartReport.downloadPdf' | transloco }}
                                    </button>

                                    <button
                                        mat-stroked-button
                                        (click)="sendEmail()"
                                        [disabled]="isSending()"
                                        class="w-full !rounded-xl !inline-flex !items-center !justify-center"
                                    >
                                        @if (isSending()) {
                                            <mat-icon class="animate-spin mr-2 !align-middle"
                                                >refresh</mat-icon
                                            >
                                            {{ 'smartReport.sending' | transloco }}
                                        } @else {
                                            {{ 'smartReport.sendViaEmail' | transloco }}
                                        }
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Right column: Step results layout + PDF Preview -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Step results layout (print-style, drag-and-drop) -->
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h3 class="font-semibold text-gray-900">{{ 'smartReport.stepResultsLayout' | transloco }}</h3>
                                    <p class="text-xs text-gray-500 mt-0.5">
                                        @if (selectedRowIndex() != null) {
                                            {{ 'smartReport.reportForRecord' | transloco: { index: selectedRowIndex()! + 1 } }}
                                        } @else {
                                            {{ 'smartReport.dragSectionsReorder' | transloco }}
                                        }
                                    </p>
                                </div>
                                @if (stepResultBlocks().length > 0) {
                                    <mat-button-toggle-group
                                        [value]="stepResultsViewMode()"
                                        (change)="stepResultsViewMode.set($event.value)"
                                        class="!rounded-lg"
                                    >
                                        <mat-button-toggle value="readable">
                                            {{ 'smartReport.viewModeReadable' | transloco }}
                                        </mat-button-toggle>
                                        <mat-button-toggle value="json">
                                            {{ 'smartReport.viewModeJson' | transloco }}
                                        </mat-button-toggle>
                                    </mat-button-toggle-group>
                                }
                            </div>
                        </div>
                        <div class="p-6">
                            @if (stepResultBlocks().length === 0) {
                                <div
                                    class="flex flex-col items-center justify-center py-12 text-gray-400"
                                >
                                    <mat-icon class="!text-5xl !w-12 !h-12 mb-3"
                                        >table_chart</mat-icon
                                    >
                                    <p class="text-sm font-medium">{{ 'smartReport.noStepResultsYet' | transloco }}</p>
                                    <p class="text-xs mt-1">
                                        {{ 'smartReport.processBatchToSeeResults' | transloco }}
                                    </p>
                                </div>
                            } @else {
                                <div
                                    class="mx-auto bg-[#fafafa] rounded-lg border border-gray-200 shadow-sm p-6 min-h-[400px]"
                                    style="max-width: 210mm"
                                >
                                    <div
                                        cdkDropList
                                        (cdkDropListDropped)="onStepBlocksDrop($event)"
                                        class="space-y-4"
                                    >
                                        @for (block of stepResultBlocks(); track block.sequence) {
                                            <div
                                                cdkDrag
                                                class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
                                            >
                                                <div
                                                    class="flex items-center gap-3 px-4 py-2.5 border-b border-gray-100 bg-gray-50"
                                                >
                                                    <div
                                                        cdkDragHandle
                                                        class="w-8 h-8 rounded flex items-center justify-center cursor-grab text-gray-400 hover:bg-gray-200 transition-colors"
                                                    >
                                                        <mat-icon class="!text-base"
                                                            >drag_indicator</mat-icon
                                                        >
                                                    </div>
                                                    <span class="font-medium text-gray-900">{{
                                                        block.label
                                                    }}</span>
                                                    <span class="text-xs text-gray-500"
                                                        >{{ 'smartReport.step' | transloco }} {{ block.sequence }}</span
                                                    >
                                                </div>
                                                @if (stepResultsViewMode() === 'readable') {
                                                    <!-- Human-readable: label/value pairs (like batch-processing) -->
                                                    <div class="px-4 py-3 bg-white border-t border-gray-100">
                                                        @for (row of block.rowResults; track row.rowIndex) {
                                                            <div
                                                                class="border-b border-gray-100 last:border-0 pb-3 last:pb-0 mb-3 last:mb-0"
                                                            >
                                                                @if (block.rowResults.length > 1) {
                                                                    <p class="text-xs font-medium text-gray-500 mb-2">
                                                                        {{ 'smartReport.row' | transloco }} #{{ row.rowIndex + 1 }}
                                                                    </p>
                                                                }
                                                                @if (row.data != null) {
                                                                    <div class="space-y-0">
                                                                        @for (field of getStepResultFields(row.data); track field.label) {
                                                                            <div class="flex gap-4 py-2 border-b border-gray-100 last:border-0 text-sm">
                                                                                <span class="text-gray-500 min-w-[140px] shrink-0">{{ field.label }}</span>
                                                                                <span class="text-gray-900 font-medium break-words">{{ field.value }}</span>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                } @else {
                                                                    <p class="text-sm text-gray-400 py-2">—</p>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                } @else {
                                                    <!-- JSON view: raw formatted JSON -->
                                                    <div class="px-4 py-3 bg-white border-t border-gray-100 overflow-x-auto">
                                                        @for (row of block.rowResults; track row.rowIndex) {
                                                            <div
                                                                class="border-b border-gray-100 last:border-0 pb-3 last:pb-0 mb-3 last:mb-0"
                                                            >
                                                                @if (block.rowResults.length > 1) {
                                                                    <p class="text-xs font-medium text-gray-500 mb-2">
                                                                        {{ 'smartReport.row' | transloco }} #{{ row.rowIndex + 1 }}
                                                                    </p>
                                                                }
                                                                <pre class="bg-gray-50 rounded-lg p-3 text-xs font-mono text-gray-800 overflow-auto max-h-64">{{
                                                                    formatJson(row.data)
                                                                }}</pre>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Report Preview (same as builder) -->
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                            <h3 class="font-semibold text-gray-900">{{ 'smartReport.preview' | transloco }}</h3>
                            <p class="text-xs text-gray-500 mt-0.5">
                                {{ 'smartReport.previewSameAsBuilder' | transloco }}
                            </p>
                        </div>

                        <div class="min-h-[600px] p-6 overflow-auto">
                            @if (isGenerating()) {
                                <div
                                    class="flex flex-col items-center justify-center h-64 text-gray-400"
                                >
                                    <mat-spinner diameter="48" class="mb-4"></mat-spinner>
                                    <p>{{ 'smartReport.generatingPdf' | transloco }}</p>
                                </div>
                            } @else if (selectedTemplate() && batch()?.rows?.length) {
                                <report-preview
                                    [template]="selectedTemplate()!"
                                    [previewData]="previewData()"
                                    [primaryColor]="selectedTemplate()!.primaryColor || '#4F46E5'"
                                    [orientation]="'portrait'"
                                    [clickable]="false"
                                />
                            } @else {
                                <div
                                    class="flex flex-col items-center justify-center h-64 text-gray-400"
                                >
                                    <mat-icon class="!text-6xl !w-16 !h-16 mb-4"
                                        >description</mat-icon
                                    >
                                    <p class="text-lg mb-2">{{ 'smartReport.noPreviewAvailable' | transloco }}</p>
                                    <p class="text-sm">
                                        {{ 'smartReport.selectTemplateAndBatch' | transloco }}
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
