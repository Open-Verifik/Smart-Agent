import{a as he,b as ge,c as be}from"./chunk-3UBK4NDG.js";import{a as Ce,b as we,c as ve,d as Re}from"./chunk-2UVUJSNJ.js";import{a as me,b as _e,c as ue,d as xe,e as fe}from"./chunk-WYCCYY5Z.js";import{a as ce}from"./chunk-CE5WN7WZ.js";import{j as re}from"./chunk-M2EUSKUB.js";import"./chunk-NJIOGT5G.js";import"./chunk-3RK6DDJD.js";import{b as de}from"./chunk-ROUQQB6E.js";import"./chunk-5EMO6V7L.js";import{a as ae,b as le}from"./chunk-O7BLLMPM.js";import"./chunk-7RWCIHFI.js";import"./chunk-DWO7TAHE.js";import{a as se,b as pe}from"./chunk-X2B33RZ7.js";import{c as H,f as W}from"./chunk-NCGURMCY.js";import{a as ne,b as oe}from"./chunk-QAYTNEMP.js";import{a as ee,c as te,d as ie}from"./chunk-AR6BYMPL.js";import{b as N,d as J,i as z}from"./chunk-5HIRALMD.js";import"./chunk-2MXYWD4L.js";import"./chunk-RV3RUMIR.js";import"./chunk-BX66S53T.js";import"./chunk-GEBYTXGS.js";import"./chunk-ELGVYL4R.js";import{U as Y,V as Z,X as K,Z as Q,_ as X}from"./chunk-RMO4OYE5.js";import{$b as A,Bc as V,Cb as I,Db as k,Eb as a,Fb as r,Ga as C,Gb as D,Kb as y,Mb as w,Nb as u,Wa as l,Xb as d,Yb as b,Zb as f,_b as E,ad as q,fb as U,ga as v,gc as F,lb as g,mc as m,md as G,nc as _,oc as M,qa as R,ra as S,sb as T,tb as j,ub as $,zb as h}from"./chunk-QTVKNRSK.js";import{a as L,h as B}from"./chunk-MG3ERZGY.js";function Ee(t,s){if(!t||!s)return;let e=t.split("."),i=s;for(let n of e){if(i==null||typeof i!="object")return;i=i[n]}return i}function Ve(t,s){return t==null?!1:s?typeof t=="object"&&!Array.isArray(t):!0}function De(t){let s=[],e=i=>{i?.dataPath&&(i.type==="field"?s.push({path:i.dataPath,label:i.label,isTable:!1}):i.type==="table"&&s.push({path:i.dataPath,label:i.label,isTable:!0}))};t.header?.dataPath&&e(t.header),t.footer?.dataPath&&e(t.footer);for(let i of t.sections??[])e(i);return s}function Se(t){return{inputData:t.inputData??{},results:t.results??{}}}function ye(t,s){let e=De(t),i=[],n=[];for(let{path:o,label:p,isTable:c}of e){let x=Ee(o,s);Ve(x,c)?i.push(o):n.push({path:o,label:p})}return{matches:n.length===0,matchedPaths:i,missingPaths:n}}var Te=t=>({count:t}),Fe=t=>({index:t}),Me=(t,s)=>s._id,Pe=(t,s)=>s.sequence,Ie=(t,s)=>s.rowIndex,je=(t,s)=>s.label;function $e(t,s){t&1&&(a(0,"div",11),D(1,"mat-spinner",13),r())}function Oe(t,s){if(t&1){let e=y();a(0,"div",18)(1,"mat-icon",33),d(2,"description"),r(),a(3,"p",34),d(4),m(5,"transloco"),r(),a(6,"button",35),w("click",function(){R(e);let n=u(2);return S(n.openReportBuilder(!0))}),d(7),m(8,"transloco"),r()()}t&2&&(l(4),b(_(5,2,"smartReport.noTemplatesFound")),l(3),f(" ",_(8,4,"smartReport.createTemplate")," "))}function Le(t,s){t&1&&(a(0,"span",43)(1,"mat-icon",45),d(2,"check_circle"),r(),d(3),m(4,"transloco"),r()),t&2&&(l(3),f(" ",_(4,1,"smartReport.templateMatchesData")," "))}function Ue(t,s){if(t&1&&(a(0,"span",44),m(1,"transloco"),a(2,"mat-icon",45),d(3,"warning"),r(),d(4),m(5,"transloco"),r()),t&2){let e=u(),i=u(4);T("matTooltip",_(1,2,"smartReport.paths")+": "+i.formatMissingPaths(e.missingPaths)),l(4),f(" ",M(5,4,"smartReport.missingFields",F(7,Te,e.missingPaths.length))," ")}}function Ae(t,s){if(t&1&&g(0,Le,5,3,"span",43)(1,Ue,6,9,"span",44),t&2){let e=s;h(e.matches?0:e.missingPaths.length>0?1:-1)}}function qe(t,s){if(t&1){let e=y();a(0,"div",37),w("click",function(){let n=R(e).$implicit,o=u(3);return S(o.selectTemplate(n))}),a(1,"div",38)(2,"div",39)(3,"mat-icon"),d(4," description "),r()(),a(5,"div",40)(6,"p",41),d(7),r(),a(8,"p",42),d(9),m(10,"transloco"),r(),g(11,Ae,2,1),r()()()}if(t&2){let e,i,n,o,p,c=s.$implicit,x=u(3);$("border-indigo-500",((e=x.selectedTemplate())==null?null:e._id)===c._id)("bg-indigo-50",((i=x.selectedTemplate())==null?null:i._id)===c._id)("border-gray-200",((n=x.selectedTemplate())==null?null:n._id)!==c._id)("hover:border-indigo-300",((o=x.selectedTemplate())==null?null:o._id)!==c._id),l(2),j("background",(c.primaryColor||"#4F46E5")+"20"),l(),j("color",c.primaryColor||"#4F46E5"),l(4),f(" ",c.name," "),l(2),A(" ",(c.sections==null?null:c.sections.length)||0," ",_(10,17,"smartReport.sections")," \u2022 ",c.pdfEngine||"puppeteer"," "),l(2),h((p=((p=x.selectedTemplate())==null?null:p._id)===c._id&&x.templateMatch())?11:-1,p)}}function Ge(t,s){if(t&1&&(a(0,"div",19),I(1,qe,12,19,"div",36,Me),r()),t&2){let e=u(2);l(),k(e.templates())}}function Ne(t,s){if(t&1){let e=y();a(0,"p",47)(1,"mat-icon",48),d(2,"check_circle"),r(),a(3,"span"),d(4),m(5,"transloco"),r()(),a(6,"button",49),w("click",function(){R(e);let n=u(3);return S(n.openReportBuilder())}),a(7,"mat-icon",50),d(8,"edit"),r(),d(9),m(10,"transloco"),r()}t&2&&(l(4),b(_(5,2,"smartReport.templateReadyToUse")),l(5),f(" ",_(10,4,"smartReport.editInBuilder")," "))}function Je(t,s){if(t&1){let e=y();a(0,"p",51)(1,"mat-icon",48),d(2,"warning"),r(),a(3,"span"),d(4),m(5,"transloco"),r()(),a(6,"p",52),d(7),m(8,"transloco"),r(),a(9,"button",53),w("click",function(){R(e);let n=u(3);return S(n.openReportBuilder())}),a(10,"mat-icon",50),d(11,"edit"),r(),d(12),m(13,"transloco"),r()}if(t&2){let e=u(),i=u(2);l(4),b(M(5,4,"smartReport.missingFieldsEditInBuilder",F(11,Te,e.missingPaths.length))),l(3),E(" ",_(8,7,"smartReport.paths"),": ",i.formatMissingPaths(e.missingPaths)," "),l(5),f(" ",_(13,9,"smartReport.editInBuilder")," ")}}function ze(t,s){if(t&1&&(a(0,"div",46),g(1,Ne,11,6)(2,Je,14,13),r()),t&2){let e=s;$("bg-emerald-50",e.matches)("bg-amber-50",!e.matches),l(),h(e.matches?1:2)}}function He(t,s){t&1&&(a(0,"mat-icon",56),d(1,"refresh"),r(),d(2),m(3,"transloco")),t&2&&(l(2),f(" ",_(3,1,"smartReport.generating")," "))}function We(t,s){t&1&&(d(0),m(1,"transloco")),t&2&&f(" ",_(1,1,"smartReport.generatePdf")," ")}function Ye(t,s){t&1&&(a(0,"mat-icon",56),d(1,"refresh"),r(),d(2),m(3,"transloco")),t&2&&(l(2),f(" ",_(3,1,"smartReport.sending")," "))}function Ze(t,s){t&1&&(d(0),m(1,"transloco")),t&2&&f(" ",_(1,1,"smartReport.sendViaEmail")," ")}function Ke(t,s){if(t&1){let e=y();a(0,"button",57),w("click",function(){R(e);let n=u(3);return S(n.downloadReport())}),a(1,"mat-icon",58),d(2,"download"),r(),d(3),m(4,"transloco"),r(),a(5,"button",59),w("click",function(){R(e);let n=u(3);return S(n.sendEmail())}),g(6,Ye,4,3)(7,Ze,2,3),r()}if(t&2){let e=u(3);l(3),f(" ",_(4,3,"smartReport.downloadPdf")," "),l(2),T("disabled",e.isSending()),l(),h(e.isSending()?6:7)}}function Qe(t,s){if(t&1){let e=y();a(0,"div",21)(1,"h3",17),d(2),m(3,"transloco"),r(),a(4,"div",54)(5,"button",55),w("click",function(){R(e);let n=u(2);return S(n.generateReport())}),g(6,He,4,3)(7,We,2,3),r(),g(8,Ke,8,5),r()()}if(t&2){let e=u(2);l(2),b(_(3,4,"smartReport.actions")),l(3),T("disabled",e.isGenerating()),l(),h(e.isGenerating()?6:7),l(2),h(e.report()?8:-1)}}function Xe(t,s){if(t&1&&(d(0),m(1,"transloco")),t&2){let e=u(2);f(" ",M(1,1,"smartReport.reportForRecord",F(4,Fe,e.selectedRowIndex()+1))," ")}}function et(t,s){t&1&&(d(0),m(1,"transloco")),t&2&&f(" ",_(1,1,"smartReport.dragSectionsReorder")," ")}function tt(t,s){if(t&1){let e=y();a(0,"mat-button-toggle-group",60),w("change",function(n){R(e);let o=u(2);return S(o.stepResultsViewMode.set(n.value))}),a(1,"mat-button-toggle",61),d(2),m(3,"transloco"),r(),a(4,"mat-button-toggle",62),d(5),m(6,"transloco"),r()()}if(t&2){let e=u(2);T("value",e.stepResultsViewMode()),l(2),f(" ",_(3,3,"smartReport.viewModeReadable")," "),l(3),f(" ",_(6,5,"smartReport.viewModeJson")," ")}}function it(t,s){t&1&&(a(0,"div",28)(1,"mat-icon",63),d(2,"table_chart"),r(),a(3,"p",64),d(4),m(5,"transloco"),r(),a(6,"p",65),d(7),m(8,"transloco"),r()()),t&2&&(l(4),b(_(5,2,"smartReport.noStepResultsYet")),l(3),f(" ",_(8,4,"smartReport.processBatchToSeeResults")," "))}function nt(t,s){if(t&1&&(a(0,"p",74),d(1),m(2,"transloco"),r()),t&2){let e=u().$implicit;l(),E(" ",_(2,2,"smartReport.row")," #",e.rowIndex+1," ")}}function ot(t,s){if(t&1&&(a(0,"div",77)(1,"span",78),d(2),r(),a(3,"span",79),d(4),r()()),t&2){let e=s.$implicit;l(2),b(e.label),l(2),b(e.value)}}function rt(t,s){if(t&1&&(a(0,"div",75),I(1,ot,5,2,"div",77,je),r()),t&2){let e=u().$implicit,i=u(5);l(),k(i.getStepResultFields(e.data))}}function at(t,s){t&1&&(a(0,"p",76),d(1,"\u2014"),r())}function lt(t,s){if(t&1&&(a(0,"div",73),g(1,nt,3,4,"p",74)(2,rt,3,0,"div",75)(3,at,2,0,"p",76),r()),t&2){let e=s.$implicit,i=u(2).$implicit;l(),h(i.rowResults.length>1?1:-1),l(),h(e.data!=null?2:3)}}function st(t,s){if(t&1&&(a(0,"div",71),I(1,lt,4,2,"div",73,Ie),r()),t&2){let e=u().$implicit;l(),k(e.rowResults)}}function pt(t,s){if(t&1&&(a(0,"p",74),d(1),m(2,"transloco"),r()),t&2){let e=u().$implicit;l(),E(" ",_(2,2,"smartReport.row")," #",e.rowIndex+1," ")}}function dt(t,s){if(t&1&&(a(0,"div",73),g(1,pt,3,4,"p",74),a(2,"pre",80),d(3),r()()),t&2){let e=s.$implicit,i=u(2).$implicit,n=u(3);l(),h(i.rowResults.length>1?1:-1),l(2),b(n.formatJson(e.data))}}function ct(t,s){if(t&1&&(a(0,"div",72),I(1,dt,4,2,"div",73,Ie),r()),t&2){let e=u().$implicit;l(),k(e.rowResults)}}function mt(t,s){if(t&1&&(a(0,"div",67)(1,"div",68)(2,"div",69)(3,"mat-icon",70),d(4,"drag_indicator"),r()(),a(5,"span",41),d(6),r(),a(7,"span",42),d(8),m(9,"transloco"),r()(),g(10,st,3,0,"div",71)(11,ct,3,0,"div",72),r()),t&2){let e=s.$implicit,i=u(3);l(6),b(e.label),l(2),E("",_(9,4,"smartReport.step")," ",e.sequence,""),l(2),h(i.stepResultsViewMode()==="readable"?10:11)}}function _t(t,s){if(t&1){let e=y();a(0,"div",29)(1,"div",66),w("cdkDropListDropped",function(n){R(e);let o=u(2);return S(o.onStepBlocksDrop(n))}),I(2,mt,12,6,"div",67,Pe),r()()}if(t&2){let e=u(2);l(2),k(e.stepResultBlocks())}}function ut(t,s){t&1&&(a(0,"div",31),D(1,"mat-spinner",81),a(2,"p"),d(3),m(4,"transloco"),r()()),t&2&&(l(3),b(_(4,1,"smartReport.generatingPdf")))}function xt(t,s){if(t&1&&D(0,"report-preview",32),t&2){let e=u(2);T("template",e.selectedTemplate())("previewData",e.previewData())("primaryColor",e.selectedTemplate().primaryColor||"#4F46E5")("orientation","portrait")("clickable",!1)}}function ft(t,s){t&1&&(a(0,"div",31)(1,"mat-icon",82),d(2,"description"),r(),a(3,"p",83),d(4),m(5,"transloco"),r(),a(6,"p",34),d(7),m(8,"transloco"),r()()),t&2&&(l(4),b(_(5,2,"smartReport.noPreviewAvailable")),l(3),f(" ",_(8,4,"smartReport.selectTemplateAndBatch")," "))}function ht(t,s){if(t&1&&(a(0,"div",12)(1,"div",14)(2,"div",15)(3,"div",16)(4,"h3",17),d(5),m(6,"transloco"),r(),g(7,Oe,9,6,"div",18)(8,Ge,3,0,"div",19),r(),g(9,ze,3,5,"div",20),r(),g(10,Qe,9,6,"div",21),r(),a(11,"div",22)(12,"div",15)(13,"div",23)(14,"div",24)(15,"div")(16,"h3",25),d(17),m(18,"transloco"),r(),a(19,"p",26),g(20,Xe,2,6)(21,et,2,3),r()(),g(22,tt,7,7,"mat-button-toggle-group",27),r()(),a(23,"div",16),g(24,it,9,6,"div",28)(25,_t,4,0,"div",29),r()(),a(26,"div",15)(27,"div",23)(28,"h3",25),d(29),m(30,"transloco"),r(),a(31,"p",26),d(32),m(33,"transloco"),r()(),a(34,"div",30),g(35,ut,5,3,"div",31)(36,xt,1,5,"report-preview",32)(37,ft,9,6,"div",31),r()()()()),t&2){let e,i,n=u();l(5),b(_(6,11,"smartReport.selectTemplate")),l(2),h(n.templates().length===0?7:8),l(2),h((e=n.selectedTemplate()&&n.templateMatch())?9:-1,e),l(),h(n.selectedTemplate()?10:-1),l(7),b(_(18,13,"smartReport.stepResultsLayout")),l(3),h(n.selectedRowIndex()!=null?20:21),l(2),h(n.stepResultBlocks().length>0?22:-1),l(2),h(n.stepResultBlocks().length===0?24:25),l(5),b(_(30,15,"smartReport.preview")),l(3),f(" ",_(33,17,"smartReport.previewSameAsBuilder")," "),l(3),h(n.isGenerating()?35:n.selectedTemplate()&&(!((i=n.batch())==null||i.rows==null)&&i.rows.length)?36:37)}}var Yt=(()=>{class t{constructor(){this._route=v(N),this._router=v(J),this._snack=v(ae),this._reportService=v(Ce),this._batchService=v(ce),this._previewDataService=v(we),this._sanitizer=v(G),this._dialog=v(H),this._transloco=v(ee),this.configId=C(null),this.batchId=C(null),this.selectedRowIndex=C(null),this.batch=C(null),this.configuration=C(null),this.templates=C([]),this.selectedTemplate=C(null),this.report=C(null),this.stepBlocksOrder=C([]),this.isLoading=C(!1),this.isGenerating=C(!1),this.isSending=C(!1),this.stepResultsViewMode=C("readable"),this.pdfDataUrl=C(null),this.pdfSafeUrl=C(null),this.stepResultBlocks=V(()=>{let e=this.stepBlocksOrder(),n=this.batch()?.rows??[],o=this.selectedRowIndex();return o!=null&&(n=n.filter(p=>p.rowIndex===o)),e.map(p=>({sequence:p.sequence,label:p.label,rowResults:n.map(c=>({rowIndex:c.rowIndex,data:c.results?.[p.sequence]??null}))}))}),this.hasStepResults=V(()=>(this.batch()?.rows??[]).some(n=>n.results&&Object.keys(n.results).length>0)),this.previewData=V(()=>{let e=this.batch(),i=e?.rows??[],n=this.selectedRowIndex(),o=n!=null?i.find(p=>p.rowIndex===n):i[0];return o?{batchName:e?.name??"Batch",rowIndex:o.rowIndex,inputData:o.inputData??{},results:o.results??{}}:{inputData:{},results:{}}}),this.templateMatch=V(()=>{let e=this.selectedTemplate(),i=this.batch();if(!e?.sections?.length||!i?.rows?.length)return null;let n=i.rows,o=this.selectedRowIndex(),p=o!=null?n.find(x=>x.rowIndex===o):n[0];if(!p)return null;let c=Se(p);return ye(e,c)})}ngOnInit(){this._route.params.subscribe(e=>{this.configId.set(e.configId),this.batchId.set(e.batchId),this._loadData()}),this._route.queryParams.subscribe(e=>{let i=e.rowIndex;if(i!=null&&i!==""){let n=parseInt(i,10);this.selectedRowIndex.set(Number.isNaN(n)?null:n)}else this.selectedRowIndex.set(null)})}_loadData(){this.isLoading.set(!0);let e=this.configId(),i=this.batchId(),n=o=>{this._reportService.getTemplates(e||void 0).subscribe({next:p=>{if(this.templates.set(p),p.length>0){let c=o?typeof o.preferredReportTemplate=="string"?o.preferredReportTemplate:o.preferredReportTemplate?._id:null,x=c?p.find(P=>P._id===c):null;this.selectedTemplate.set(x??p[0])}this.isLoading.set(!1)},error:()=>{this.isLoading.set(!1)}})};e?this._batchService.getConfiguration(e).subscribe({next:o=>{this.configuration.set(o.data),this._initStepBlocksOrderFromConfig(o.data),i?this._batchService.getSmartBatch(i).subscribe({next:p=>{this.batch.set(p.data),n(o.data)},error:()=>n(o.data)}):n(o.data)},error:()=>{i&&this._batchService.getSmartBatch(i).subscribe({next:o=>this.batch.set(o.data),error:()=>{}}),n(null)}}):(i&&this._batchService.getSmartBatch(i).subscribe({next:o=>this.batch.set(o.data),error:()=>{}}),n(null))}_initStepBlocksOrderFromConfig(e){if(!e?.steps?.length)return;let i=e.steps.filter(n=>n.enabled).sort((n,o)=>n.sequence-o.sequence).map(n=>({sequence:n.sequence,label:this._getStepLabel(n)}));i.length>0&&this.stepBlocksOrder.set(i)}_getStepLabel(e){let i=e.appFeature;return i?.name||i?.code||`Step ${e.sequence}`}onStepBlocksDrop(e){let i=[...this.stepBlocksOrder()];me(i,e.previousIndex,e.currentIndex),this.stepBlocksOrder.set(i)}getStepResultFields(e){if(e==null||typeof e!="object")return[{label:"Result",value:e!=null?String(e):"\u2014"}];let i=[];for(let n of Object.keys(e)){let o=n.replace(/([A-Z])/g," $1").replace(/^./,x=>x.toUpperCase()).trim(),p=e[n],c;p==null?c="\u2014":Array.isArray(p)?c=p.length===0?"\u2014":`[${p.length} item${p.length===1?"":"s"}]`:typeof p=="object"?c=typeof p=="object"&&p!==null&&Object.keys(p).length>0?`{ ${Object.keys(p).slice(0,3).join(", ")}${Object.keys(p).length>3?"\u2026":""} }`:"\u2014":c=String(p),i.push({label:o,value:c})}return i}formatJson(e){if(e==null)return"\u2014";try{return JSON.stringify(e,null,2)}catch{return String(e)}}getResultSummary(e){if(e==null)return"\u2014";if(typeof e=="string")return e.length>60?e.slice(0,60)+"\u2026":e;if(typeof e!="object")return String(e);let i=Object.keys(e);return i.length===0?"\u2014":i.slice(0,3).map(o=>`${o}: ${this._valuePreview(e[o])}`).join(" \xB7 ")+(i.length>3?" \u2026":"")}_valuePreview(e){return e==null?"\u2014":typeof e=="string"?e.length>20?e.slice(0,20)+"\u2026":e:typeof e=="object"?"\u2026":String(e)}_isPdfBlob(e){return B(this,null,function*(){let n=yield e.slice(0,5).arrayBuffer(),o=new Uint8Array(n);return o[0]===37&&o[1]===80&&o[2]===68&&o[3]===70})}_blobFromJsonBytes(e){return B(this,null,function*(){try{let i=yield e.text(),n=JSON.parse(i),o=Object.keys(n).filter(c=>/^\d+$/.test(c));if(o.length===0)return null;o.sort((c,x)=>Number(c)-Number(x));let p=new Uint8Array(o.length);return o.forEach((c,x)=>p[x]=n[c]&255),p[0]!==37||p[1]!==80||p[2]!==68||p[3]!==70?null:new Blob([p],{type:"application/pdf"})}catch{return null}})}_parseBlobError(e){return B(this,null,function*(){try{let i=yield e.text(),n=JSON.parse(i);return typeof n.error=="string"?n.error:typeof n.message=="string"?n.message:Object.keys(n).some(o=>/^\d+$/.test(o))?"Server returned PDF in unexpected format":i.slice(0,80)}catch{return e.type==="application/json"||e.type==="text/plain"?"Server returned an error":"Invalid PDF content"}})}formatMissingPaths(e){return e.map(i=>i.path).join(", ")}selectTemplate(e){this.selectedTemplate.set(e),this.pdfDataUrl.set(null),this.pdfSafeUrl.set(null),this.report.set(null);let i=this.configId();i&&e._id&&this._batchService.updateConfiguration(i,{preferredReportTemplate:e._id}).subscribe({next:n=>this.configuration.set(n.data),error:()=>this._snack.open(this._transloco.translate("smartReport.failedToSaveTemplatePreference"),"Close",{duration:3e3})})}generateReport(){let e=this.selectedTemplate(),i=this.batchId();if(!e||!i){this._snack.open(this._transloco.translate("smartReport.pleaseSelectTemplate"),"Close",{duration:3e3});return}this.isGenerating.set(!0),this._reportService.createReport({template:e._id,smartBatch:i,name:`Report - ${this.batch()?.name||"Batch"}`}).subscribe({next:n=>{this.report.set(n);let o=this.selectedRowIndex();this._reportService.generateReport(n._id,L({},o!=null?{rowIndex:o}:{})).subscribe({next:p=>{if(this.report.set(p.data),p.pdf?.buffer){let c=`data:application/pdf;base64,${p.pdf.buffer}`;this.pdfDataUrl.set(c),this.pdfSafeUrl.set(this._sanitizer.bypassSecurityTrustResourceUrl(c))}this.isGenerating.set(!1),this._snack.open(this._transloco.translate("smartReport.reportGenerated"),"Close",{duration:3e3})},error:p=>{console.error("Failed to generate PDF:",p),this.isGenerating.set(!1),this._snack.open(this._transloco.translate("smartReport.failedToGenerateReport"),"Close",{duration:3e3})}})},error:n=>{console.error("Failed to create report:",n),this.isGenerating.set(!1),this._snack.open(this._transloco.translate("smartReport.failedToCreateReport"),"Close",{duration:3e3})}})}sendEmail(){let e=this.report();if(!e?._id){this._snack.open(this._transloco.translate("smartReport.generateReportFirst"),"Close",{duration:3e3});return}let i=`Report - ${this.batch()?.name??"Batch"}`;this._dialog.open(Re,{panelClass:"send-sample-dialog",maxWidth:"560px",width:"95vw",disableClose:!1,autoFocus:!0,data:{defaultSubject:i,isSample:!1}}).afterClosed().subscribe(o=>{o?.recipients?.length&&(this.isSending.set(!0),this._reportService.sendReportEmail(e._id,{recipients:o.recipients,subject:o.subject,language:"es"}).subscribe({next:p=>{this.isSending.set(!1),p.success?this._snack.open(this._transloco.translate("smartReport.emailSent"),"Close",{duration:3e3}):this._snack.open(p.error||this._transloco.translate("smartReport.failedToSendEmail"),"Close",{duration:3e3})},error:()=>{this.isSending.set(!1),this._snack.open(this._transloco.translate("smartReport.failedToSendEmail"),"Close",{duration:3e3})}}))})}downloadReport(){let e=this.report();if(!e?._id){this._snack.open(this._transloco.translate("smartReport.generateReportFirst"),"Close",{duration:3e3});return}this.isSending.set(!0),this._reportService.downloadReport(e._id).subscribe({next:i=>B(this,null,function*(){let n=i;if(!(yield this._isPdfBlob(i))&&(n=yield this._blobFromJsonBytes(i),!n)){let x=yield this._parseBlobError(i);this._snack.open(x||this._transloco.translate("smartReport.invalidPdfReceived"),"Close",{duration:4e3});return}let p=URL.createObjectURL(n),c=document.createElement("a");c.href=p,c.download=`SmartReport_${e._id}.pdf`,c.click(),URL.revokeObjectURL(p),this._snack.open(this._transloco.translate("smartReport.pdfDownloaded"),"Close",{duration:2e3})}),error:()=>{this._snack.open(this._transloco.translate("smartReport.failedToDownloadPdf"),"Close",{duration:3e3})},complete:()=>{this.isSending.set(!1)}})}goBack(){let e=this.configId(),i=this.batchId();e&&i?this._router.navigate(["/smart-batch",e,"batch",i]):e&&this._router.navigate(["/smart-batch",e])}openReportBuilder(e=!1){let i=this.configId();if(!i)return;let n=this.batch(),o=n?.rows??[],p=this.selectedRowIndex(),c=p!=null?o.find(Be=>Be.rowIndex===p):o[0],x=c?{batchName:n?.name??"Batch",rowIndex:c.rowIndex,inputData:c.inputData??{},results:c.results??{}}:null;x&&this._previewDataService.setPendingPreviewData(x);let P=x?{state:{previewData:x}}:{},O=e?null:this.selectedTemplate()?._id,ke=O?["/smart-batch",i,"report-builder",O]:["/smart-batch",i,"report-builder"];this._router.navigate(ke,P)}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275cmp=U({type:t,selectors:[["report-viewer"]],decls:24,vars:13,consts:[[1,"min-h-screen","w-full","bg-gray-50"],[1,"bg-white","border-b","border-gray-200","sticky","top-0","z-10"],[1,"w-full","px-4","sm:px-6","lg:px-8","py-4"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-4"],["mat-icon-button","",3,"click","matTooltip"],[1,"text-xl","font-bold","text-gray-900"],[1,"text-sm","text-gray-500"],["mat-stroked-button","",1,"!rounded-xl",3,"click"],[1,"mr-2"],[1,"w-full","px-4","sm:px-6","lg:px-8","py-6"],[1,"flex","items-center","justify-center","h-64"],[1,"grid","grid-cols-1","lg:grid-cols-3","gap-6"],["diameter","48"],[1,"lg:col-span-1"],[1,"bg-white","rounded-2xl","border","border-gray-200","overflow-hidden"],[1,"p-6"],[1,"font-semibold","text-gray-900","mb-4"],[1,"text-center","py-8","text-gray-400"],[1,"space-y-2","max-h-[320px]","overflow-y-auto","pr-1"],[1,"border-t","border-gray-100","px-6","py-4",3,"bg-emerald-50","bg-amber-50"],[1,"bg-white","rounded-2xl","border","border-gray-200","p-6","mt-6"],[1,"lg:col-span-2","space-y-6"],[1,"bg-gray-50","border-b","border-gray-200","px-6","py-4"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-semibold","text-gray-900"],[1,"text-xs","text-gray-500","mt-0.5"],[1,"!rounded-lg",3,"value"],[1,"flex","flex-col","items-center","justify-center","py-12","text-gray-400"],[1,"mx-auto","bg-[#fafafa]","rounded-lg","border","border-gray-200","shadow-sm","p-6","min-h-[400px]",2,"max-width","210mm"],[1,"min-h-[600px]","p-6","overflow-auto"],[1,"flex","flex-col","items-center","justify-center","h-64","text-gray-400"],[3,"template","previewData","primaryColor","orientation","clickable"],[1,"!text-4xl","!w-10","!h-10","mb-2"],[1,"text-sm"],["mat-flat-button","","color","primary",1,"mt-4","!rounded-xl","!bg-indigo-600",3,"click"],[1,"p-4","rounded-xl","border","cursor-pointer","transition-all",3,"border-indigo-500","bg-indigo-50","border-gray-200","hover:border-indigo-300"],[1,"p-4","rounded-xl","border","cursor-pointer","transition-all",3,"click"],[1,"flex","items-center","gap-3"],[1,"w-10","h-10","rounded-xl","flex","items-center","justify-center","shrink-0"],[1,"flex-1","min-w-0"],[1,"font-medium","text-gray-900"],[1,"text-xs","text-gray-500"],[1,"inline-flex","items-center","gap-1","mt-1","text-xs","text-emerald-600"],[1,"inline-flex","items-center","gap-1","mt-1","text-xs","text-amber-600",3,"matTooltip"],[1,"!text-sm","!w-3.5","!h-3.5"],[1,"border-t","border-gray-100","px-6","py-4"],[1,"text-sm","text-emerald-700","mb-3","flex","items-start","gap-2"],[1,"!text-lg","!w-5","!h-5","shrink-0","mt-0.5"],["mat-stroked-button","",1,"!rounded-xl","!text-emerald-700","!border-emerald-300","!inline-flex","!items-center","!justify-center",3,"click"],[1,"mr-2","!text-lg","!align-middle"],[1,"text-sm","text-amber-700","mb-2","flex","items-start","gap-2"],[1,"text-xs","text-amber-600/80","mb-3","pl-7"],["mat-stroked-button","",1,"!rounded-xl","!text-amber-700","!border-amber-300","!inline-flex","!items-center","!justify-center",3,"click"],[1,"space-y-3"],["mat-flat-button","","color","primary",1,"w-full","!rounded-xl","!bg-indigo-600","!inline-flex","!items-center","!justify-center",3,"click","disabled"],[1,"animate-spin","mr-2","!align-middle"],["mat-stroked-button","",1,"w-full","!rounded-xl","!inline-flex","!items-center","!justify-center",3,"click"],[1,"mr-2","!align-middle"],["mat-stroked-button","",1,"w-full","!rounded-xl","!inline-flex","!items-center","!justify-center",3,"click","disabled"],[1,"!rounded-lg",3,"change","value"],["value","readable"],["value","json"],[1,"!text-5xl","!w-12","!h-12","mb-3"],[1,"text-sm","font-medium"],[1,"text-xs","mt-1"],["cdkDropList","",1,"space-y-4",3,"cdkDropListDropped"],["cdkDrag","",1,"bg-white","border","border-gray-200","rounded-lg","overflow-hidden","shadow-sm"],[1,"flex","items-center","gap-3","px-4","py-2.5","border-b","border-gray-100","bg-gray-50"],["cdkDragHandle","",1,"w-8","h-8","rounded","flex","items-center","justify-center","cursor-grab","text-gray-400","hover:bg-gray-200","transition-colors"],[1,"!text-base"],[1,"px-4","py-3","bg-white","border-t","border-gray-100"],[1,"px-4","py-3","bg-white","border-t","border-gray-100","overflow-x-auto"],[1,"border-b","border-gray-100","last:border-0","pb-3","last:pb-0","mb-3","last:mb-0"],[1,"text-xs","font-medium","text-gray-500","mb-2"],[1,"space-y-0"],[1,"text-sm","text-gray-400","py-2"],[1,"flex","gap-4","py-2","border-b","border-gray-100","last:border-0","text-sm"],[1,"text-gray-500","min-w-[140px]","shrink-0"],[1,"text-gray-900","font-medium","break-words"],[1,"bg-gray-50","rounded-lg","p-3","text-xs","font-mono","text-gray-800","overflow-auto","max-h-64"],["diameter","48",1,"mb-4"],[1,"!text-6xl","!w-16","!h-16","mb-4"],[1,"text-lg","mb-2"]],template:function(i,n){if(i&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4)(5,"button",5),m(6,"transloco"),w("click",function(){return n.goBack()}),a(7,"mat-icon"),d(8,"arrow_back"),r()(),a(9,"div")(10,"h1",6),d(11),m(12,"transloco"),r(),a(13,"p",7),d(14),m(15,"transloco"),r()()(),a(16,"button",8),w("click",function(){return n.openReportBuilder(!0)}),a(17,"mat-icon",9),d(18,"design_services"),r(),d(19),m(20,"transloco"),r()()()(),a(21,"div",10),g(22,$e,2,0,"div",11)(23,ht,38,19,"div",12),r()()),i&2){let o;l(5),T("matTooltip",_(6,5,"smartReport.back")),l(6),b(_(12,7,"smartReport.generateReport")),l(3),b(((o=n.batch())==null?null:o.name)||_(15,9,"smartReport.batchReport")),l(5),f(" ",_(20,11,"smartReport.createTemplate")," "),l(3),h(n.isLoading()?22:23)}},dependencies:[q,z,fe,xe,ue,_e,K,Z,Y,be,he,ge,W,X,Q,pe,se,de,oe,ne,le,ie,te,ve],encapsulation:2,data:{animation:[re]}})}}return t})();export{Yt as ReportViewerComponent};
