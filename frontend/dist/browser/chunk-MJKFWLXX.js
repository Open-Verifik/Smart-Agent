import{b as F,c as _}from"./chunk-VNZRP2YN.js";import{r as i}from"./chunk-E62Z5BTR.js";import{k as h}from"./chunk-23EAJY74.js";import{_ as S,da as x,ea as k,g as b}from"./chunk-S7YYVX2B.js";import{g as d}from"./chunk-GAL4ENT6.js";var N=(()=>{class y{constructor(t){this._encryptionService=t,this.balanceSubject=new b("0.00"),this.balance$=this.balanceSubject.asObservable(),this.tokenBalanceSubject=new b("0.00"),this.tokenBalance$=this.tokenBalanceSubject.asObservable(),this.RPC_URL=h.rpcUrl||"https://api.avax.network/ext/bc/C/rpc",this.VKA_CONTRACT_ADDRESS=h.vkaContractAddress,this._sessionService=k(F),this.provider=new i.providers.JsonRpcProvider(this.RPC_URL),this.provider.pollingInterval=36e5,this.provider.on("poll",(e,a)=>{console.log(`%c[RPC Poll] %cID: ${e} %cBlock: ${a} %c${new Date().toLocaleTimeString()}`,"color: #0ea5e9; font-weight: bold;","color: #64748b;","color: #eab308; font-weight: bold;","color: #94a3b8;")}),this.provider.on("block",e=>{console.log(`%c[RPC Block] %cNew Block: ${e}`,"color: #10b981; font-weight: bold;","color: #10b981;")}),window.ethereum&&window.ethereum.on("accountsChanged",e=>{localStorage.getItem("x402_wallet_type")==="metamask"&&(e.length>0?(console.log("MetaMask account changed:",e[0]),localStorage.setItem("x402_agent_address",e[0]),this._sessionService.safeReload()):(console.log("MetaMask disconnected"),this._sessionService.safeReload()))})}startActivePolling(){console.log("\u{1F680} Starting Active Polling (1.5s)..."),this.provider.pollingInterval=1500}pausePolling(){console.log("\u23F8\uFE0F Pausing Polling (Idle/1h)..."),this.provider.pollingInterval=36e5}getAddress(){return localStorage.getItem("x402_agent_address")||""}getBalance(){return d(this,null,function*(){let t=this.getAddress();if(!t)return"0.00";let e=yield this.provider.getBalance(t);return i.utils.formatEther(e)})}getTokenBalance(){return d(this,arguments,function*(t=this.VKA_CONTRACT_ADDRESS){let e=this.getAddress();if(!e)return"0.00";try{let a=["function balanceOf(address account) view returns (uint256)","function decimals() view returns (uint8)"],r=new i.Contract(t,a,this.provider),n=yield r.balanceOf(e),m=yield r.decimals();return i.utils.formatUnits(n,m)}catch(a){return console.warn("Failed to fetch token balance:",a),"0.00"}})}getSigner(){return d(this,null,function*(){let t=localStorage.getItem("x402_wallet_type"),e=this._encryptionService.getEncryptionMethod();if(!e&&this._encryptionService.isWalletEncrypted()&&(localStorage.getItem("x402_credential_id")?e="passkey":localStorage.getItem("x402_encryption_salt")&&(e="pin")),e){let a=null;if(e==="passkey")a=yield this._encryptionService.decryptWithPasskeys();else if(e==="pin"){let r=prompt("Please enter your 6-digit PIN to sign the transaction:");r&&(a=yield this._encryptionService.decryptWithPIN(r))}if(a)return new i.Wallet(a,this.provider);throw new Error("Failed to unlock wallet")}if(t==="metamask"&&window.ethereum){yield this.switchToAvalancheMainnet();let a=new i.providers.Web3Provider(window.ethereum);return yield a.send("eth_requestAccounts",[]),a.getSigner()}throw new Error("No valid wallet connected. Please sign in with your Agent Wallet or MetaMask.")})}sendTransaction(t,e,a="0x"){return d(this,null,function*(){let r=yield this.getSigner(),n={to:t,value:i.utils.parseEther(e),data:a};return yield r.sendTransaction(n)})}payForService(t,e,a,r){return d(this,null,function*(){let n=yield this.getSigner(),m=yield n.getAddress();(yield this.provider.getCode(t))==="0x"&&(console.warn(`Target ${t} is not a contract (EOA). Using fallback contract.`),t=h.x402PaymentContract);let f=["function payForService(string serviceId, string requestId) public payable"],u=new i.Contract(t,f,n),o=i.utils.parseEther(r),s=yield this.provider.getFeeData(),l;try{let v={value:o,from:m},P=yield u.estimateGas.payForService(e,a,v);l=P.mul(120).div(100),console.log("Gas estimated:",P.toString(),"With 20% buffer:",l.toString())}catch(v){console.warn("Gas estimation failed, using default:",v),l=i.BigNumber.from(12e4)}let c=i.utils.parseUnits(h.priorityFeeTipGwei||"5","gwei"),g={value:o,gasLimit:l};return s.maxFeePerGas&&s.maxPriorityFeePerGas?(g.maxPriorityFeePerGas=s.maxPriorityFeePerGas.add(c),g.maxFeePerGas=s.maxFeePerGas.mul(125).div(100).add(c)):s.gasPrice&&(g.gasPrice=s.gasPrice.mul(135).div(100)),console.log("Calling payForService with:",{contractAddress:t,serviceId:e,requestId:a,amount:r,gasLimit:l.toString(),signer:m}),{tx:yield u.payForService(e,a,g),signerAddress:m}})}submitFeedback(m,w){return d(this,arguments,function*(t,e,a=[],r="",n=null){let f=yield this.getSigner();if(e<1||e>5)throw new Error("Rating must be between 1 and 5");let u=["function submitFeedback(uint256 agentTokenId, uint8 rating, string[] memory tags, string memory comment, bytes32 paymentProof) external returns (uint256)"],o=h.reputationRegistryContract,s=new i.Contract(o,u,f),l=n&&i.utils.isHexString(n)?n:i.constants.HashZero,c=yield this.provider.getFeeData(),g;try{g=(yield s.estimateGas.submitFeedback(t,e,a,r,l)).mul(120).div(100)}catch(v){console.warn("Gas estimation failed, using default:",v),g=i.BigNumber.from(15e4)}let p={gasLimit:g};return c.gasPrice?p.gasPrice=c.gasPrice:c.maxFeePerGas&&c.maxPriorityFeePerGas&&(p.maxFeePerGas=c.maxFeePerGas,p.maxPriorityFeePerGas=c.maxPriorityFeePerGas),console.log("Submitting feedback:",{agentTokenId:t,rating:e,tags:a,comment:r,paymentTxHash:n}),yield s.submitFeedback(t,e,a,r,l,p)})}switchToAvalancheMainnet(){return d(this,null,function*(){if(!window.ethereum)return;let t="0xa86c";try{yield window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:t}]})}catch(e){if(e.code===4902)try{yield window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:t,chainName:"Avalanche Mainnet",nativeCurrency:{name:"Avalanche",symbol:"AVAX",decimals:18},rpcUrls:[h.rpcUrl||"https://api.avax.network/ext/bc/C/rpc"],blockExplorerUrls:["https://snowtrace.io/"]}]})}catch(a){console.error("Failed to add network:",a)}}})}resetWallet(){this._encryptionService.clearEncryptionData(),localStorage.removeItem("x402_agent_address"),localStorage.removeItem("x402_wallet_type"),this._sessionService.safeReload()}refreshBalance(){return d(this,null,function*(){try{let t=yield this.getBalance();this.balanceSubject.next(t);let e=yield this.getTokenBalance();this.tokenBalanceSubject.next(e)}catch(t){console.warn("Failed to refresh balance:",t)}})}getPaymentHistory(){return d(this,arguments,function*(t=h.x402PaymentContract){let e=this.getAddress();if(!e)return[];let a=["event PaymentReceived(address indexed payer, string serviceId, string requestId, uint256 amount)"],r=new i.Contract(t,a,this.provider);console.log("Fetching payment history for:",e,"on contract:",t);let n=r.filters.PaymentReceived(e),m=yield this.provider.getBlockNumber(),w=Math.max(0,m-2e6),u=(yield r.queryFilter(n,w)).slice().reverse();return Promise.all(u.map(o=>d(this,null,function*(){let s=r.interface.parseLog(o),l=yield o.getBlock();return{transactionHash:o.transactionHash,blockNumber:o.blockNumber,timestamp:l.timestamp*1e3,serviceId:s.args.serviceId,requestId:s.args.requestId,amount:i.utils.formatEther(s.args.amount)}})))})}getTransactionDetails(t){return d(this,null,function*(){try{let e=yield this.provider.getTransaction(t);if(!e)return null;let a=yield this.provider.getTransactionReceipt(t),r=yield this.provider.getBlock(e.blockNumber);return{hash:e.hash,from:e.from,to:e.to,value:i.utils.formatEther(e.value),gasUsed:a.gasUsed.toString(),status:a.status===1?"Success":"Failed",timestamp:r.timestamp*1e3,blockNumber:e.blockNumber}}catch(e){return console.error("Error fetching tx details:",e),null}})}payForServiceWithToken(t,e,a){return d(this,null,function*(){let r=yield this.getSigner(),n=yield r.getAddress(),m=["function transfer(address to, uint256 amount) public returns (bool)","function decimals() view returns (uint8)"],w=new i.Contract(e,m,r),f=yield w.decimals(),u=i.utils.parseUnits(a,f),o=yield this.provider.getFeeData(),s;try{s=(yield w.estimateGas.transfer(t,u)).mul(120).div(100)}catch(p){console.warn("Gas estimation failed for token transfer, using default",p),s=i.BigNumber.from(1e5)}let l=i.utils.parseUnits(h.priorityFeeTipGwei||"5","gwei"),c={gasLimit:s};return o.maxFeePerGas&&o.maxPriorityFeePerGas?(c.maxPriorityFeePerGas=o.maxPriorityFeePerGas.add(l),c.maxFeePerGas=o.maxFeePerGas.mul(125).div(100).add(l)):o.gasPrice&&(c.gasPrice=o.gasPrice.mul(135).div(100)),console.log(`Sending ${a} VKA to ${t}`),{tx:yield w.transfer(t,u,c),signerAddress:n}})}static{this.\u0275fac=function(e){return new(e||y)(x(_))}}static{this.\u0275prov=S({token:y,factory:y.\u0275fac,providedIn:"root"})}}return y})();export{N as a};
