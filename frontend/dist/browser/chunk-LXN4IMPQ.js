import{b as x,c as F}from"./chunk-533J2H6T.js";import{r as i}from"./chunk-E62Z5BTR.js";import{_ as b,da as S,ea as P,g as v}from"./chunk-S7YYVX2B.js";import{g as c}from"./chunk-GAL4ENT6.js";var A=(()=>{class u{constructor(t){this._encryptionService=t,this.balanceSubject=new v("0.00"),this.balance$=this.balanceSubject.asObservable(),this.RPC_URL="https://api.avax-test.network/ext/bc/C/rpc",this._sessionService=P(x),this.provider=new i.providers.StaticJsonRpcProvider(this.RPC_URL),this.provider.pollingInterval=2e3,window.ethereum&&window.ethereum.on("accountsChanged",e=>{localStorage.getItem("x402_wallet_type")==="metamask"&&(e.length>0?(console.log("MetaMask account changed:",e[0]),localStorage.setItem("x402_agent_address",e[0]),this._sessionService.safeReload()):(console.log("MetaMask disconnected"),this._sessionService.safeReload()))})}getAddress(){return localStorage.getItem("x402_agent_address")||""}getBalance(){return c(this,null,function*(){let t=this.getAddress();if(!t)return"0.00";let e=yield this.provider.getBalance(t);return i.utils.formatEther(e)})}getSigner(){return c(this,null,function*(){let t=localStorage.getItem("x402_wallet_type"),e=this._encryptionService.getEncryptionMethod();if(!e&&this._encryptionService.isWalletEncrypted()&&(localStorage.getItem("x402_credential_id")?e="passkey":localStorage.getItem("x402_encryption_salt")&&(e="pin")),e){let a=null;if(e==="passkey")a=yield this._encryptionService.decryptWithPasskeys();else if(e==="pin"){let r=prompt("Please enter your 6-digit PIN to sign the transaction:");r&&(a=yield this._encryptionService.decryptWithPIN(r))}if(a)return new i.Wallet(a,this.provider);throw new Error("Failed to unlock wallet")}if(t==="metamask"&&window.ethereum){yield this.switchToAvalancheFuji();let a=new i.providers.Web3Provider(window.ethereum);return yield a.send("eth_requestAccounts",[]),a.getSigner()}throw new Error("No valid wallet connected. Please sign in with your Agent Wallet or MetaMask.")})}sendTransaction(t,e,a="0x"){return c(this,null,function*(){let r=yield this.getSigner(),o={to:t,value:i.utils.parseEther(e),data:a};return yield r.sendTransaction(o)})}payForService(t,e,a,r){return c(this,null,function*(){let o=yield this.getSigner(),g=yield o.getAddress();(yield this.provider.getCode(t))==="0x"&&(console.warn(`Target ${t} is not a contract (EOA). Using fallback contract.`),t="0x72Fdce477bBD9f322907b3b1C4a58bC4d5D64C3a");let w=["function payForService(string serviceId, string requestId) public payable"],h=new i.Contract(t,w,o),m=i.utils.parseEther(r),s=yield this.provider.getFeeData(),l;try{let d={value:m,from:g},p=yield h.estimateGas.payForService(e,a,d);l=p.mul(120).div(100),console.log("Gas estimated:",p.toString(),"With 20% buffer:",l.toString())}catch(d){console.warn("Gas estimation failed, using default:",d),l=i.BigNumber.from(12e4)}let n={value:m,gasLimit:l};return s.gasPrice?n.gasPrice=s.gasPrice:s.maxFeePerGas&&s.maxPriorityFeePerGas&&(n.maxFeePerGas=s.maxFeePerGas,n.maxPriorityFeePerGas=s.maxPriorityFeePerGas),console.log("Calling payForService with:",{contractAddress:t,serviceId:e,requestId:a,amount:r,gasLimit:l.toString(),signer:g}),{tx:yield h.payForService(e,a,n),signerAddress:g}})}submitFeedback(g,y){return c(this,arguments,function*(t,e,a=[],r="",o=null){let w=yield this.getSigner();if(e<1||e>5)throw new Error("Rating must be between 1 and 5");let h=["function submitFeedback(uint256 agentTokenId, uint8 rating, string[] memory tags, string memory comment, bytes32 paymentProof) external returns (uint256)"],m="0xc8AF65010D6Bf85e4DC89D9D13E9cC185df919B1",s=new i.Contract(m,h,w),l=o&&i.utils.isHexString(o)?o:i.constants.HashZero,n=yield this.provider.getFeeData(),f;try{f=(yield s.estimateGas.submitFeedback(t,e,a,r,l)).mul(120).div(100)}catch(p){console.warn("Gas estimation failed, using default:",p),f=i.BigNumber.from(15e4)}let d={gasLimit:f};return n.gasPrice?d.gasPrice=n.gasPrice:n.maxFeePerGas&&n.maxPriorityFeePerGas&&(d.maxFeePerGas=n.maxFeePerGas,d.maxPriorityFeePerGas=n.maxPriorityFeePerGas),console.log("Submitting feedback:",{agentTokenId:t,rating:e,tags:a,comment:r,paymentTxHash:o}),yield s.submitFeedback(t,e,a,r,l,d)})}switchToAvalancheFuji(){return c(this,null,function*(){if(!window.ethereum)return;let t="0xa869";try{yield window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:t}]})}catch(e){if(e.code===4902)try{yield window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:t,chainName:"Avalanche Fuji Testnet",nativeCurrency:{name:"Avalanche",symbol:"AVAX",decimals:18},rpcUrls:["https://api.avax-test.network/ext/bc/C/rpc"],blockExplorerUrls:["https://testnet.snowtrace.io/"]}]})}catch(a){console.error("Failed to add network:",a)}}})}resetWallet(){this._encryptionService.clearEncryptionData(),localStorage.removeItem("x402_agent_address"),localStorage.removeItem("x402_wallet_type"),this._sessionService.safeReload()}refreshBalance(){return c(this,null,function*(){try{let t=yield this.getBalance();this.balanceSubject.next(t)}catch(t){console.warn("Failed to refresh balance:",t)}})}getPaymentHistory(t="0x72Fdce477bBD9f322907b3b1C4a58bC4d5D64C3a"){return c(this,null,function*(){let e=this.getAddress();if(!e)return[];let a=["event PaymentReceived(address indexed payer, string serviceId, string requestId, uint256 amount)"],r=new i.Contract(t,a,this.provider);console.log("Fetching payment history for:",e,"on contract:",t);let o=r.filters.PaymentReceived(e),g=yield this.provider.getBlockNumber(),y=Math.max(0,g-2e6),h=(yield r.queryFilter(o,y)).slice().reverse();return Promise.all(h.map(m=>c(this,null,function*(){let s=r.interface.parseLog(m),l=yield m.getBlock();return{transactionHash:m.transactionHash,blockNumber:m.blockNumber,timestamp:l.timestamp*1e3,serviceId:s.args.serviceId,requestId:s.args.requestId,amount:i.utils.formatEther(s.args.amount)}})))})}getTransactionDetails(t){return c(this,null,function*(){try{let e=yield this.provider.getTransaction(t);if(!e)return null;let a=yield this.provider.getTransactionReceipt(t),r=yield this.provider.getBlock(e.blockNumber);return{hash:e.hash,from:e.from,to:e.to,value:i.utils.formatEther(e.value),gasUsed:a.gasUsed.toString(),status:a.status===1?"Success":"Failed",timestamp:r.timestamp*1e3,blockNumber:e.blockNumber}}catch(e){return console.error("Error fetching tx details:",e),null}})}static{this.\u0275fac=function(e){return new(e||u)(S(F))}}static{this.\u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();export{A as a};
