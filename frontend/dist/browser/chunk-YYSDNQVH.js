import{a as S,b as A}from"./chunk-EGZAXV2Z.js";import{Fc as o}from"./chunk-FSN63N44.js";import{aa as _,fa as k,g as v,ga as b,pd as m}from"./chunk-M2SB6WSN.js";import{a as f,b as y,i}from"./chunk-66YHNWRR.js";var g="0xa86a",F=(()=>{class w{constructor(t){this._encryptionService=t,this.balanceSubject=new v("0.00"),this.balance$=this.balanceSubject.asObservable(),this.tokenBalanceSubject=new v("0.00"),this.tokenBalance$=this.tokenBalanceSubject.asObservable(),this.RPC_URL=m.rpcUrl||"https://api.avax.network/ext/bc/C/rpc",this.VKA_CONTRACT_ADDRESS=m.vkaContractAddress,this._sessionService=b(S),this.provider=new o.JsonRpcProvider(this.RPC_URL),this.provider.pollingInterval=36e5,window.ethereum&&window.ethereum.on("accountsChanged",e=>{localStorage.getItem("x402_wallet_type")==="metamask"&&(e.length>0&&localStorage.setItem("x402_agent_address",e[0]),this._sessionService.safeReload())})}startActivePolling(){this.provider.pollingInterval=1500}pausePolling(){this.provider.pollingInterval=36e5}getAddress(){return localStorage.getItem("x402_agent_address")||""}getBalance(){return i(this,null,function*(){let t=this.getAddress();if(!t)return"0.00";let e=yield this.provider.getBalance(t);return o.formatEther(e)})}getTokenBalance(){return i(this,arguments,function*(t=this.VKA_CONTRACT_ADDRESS){let e=this.getAddress();if(!e)return"0.00";try{let a=["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"],r=new o.Contract(t,a,this.provider),[n,c]=yield Promise.all([r.balanceOf(e),r.decimals()]);return o.formatUnits(n,c)}catch{return"0.00"}})}refreshBalance(){return i(this,null,function*(){try{this.balanceSubject.next(yield this.getBalance()),this.tokenBalanceSubject.next(yield this.getTokenBalance())}catch{}})}resetWallet(){this._encryptionService.clearEncryptionData(),localStorage.removeItem("x402_agent_address"),localStorage.removeItem("x402_wallet_type"),this._sessionService.safeReload()}getSigner(){return i(this,null,function*(){let t=localStorage.getItem("x402_wallet_type"),e=this._encryptionService.getEncryptionMethod();if(!e&&this._encryptionService.isWalletEncrypted()&&(e=localStorage.getItem("x402_credential_id")?"passkey":localStorage.getItem("x402_encryption_salt")?"pin":null),e){let a=null;if(e==="passkey")a=yield this._encryptionService.decryptWithPasskeys();else if(e==="pin"){let r=prompt("Please enter your 6-digit PIN to sign the transaction:");r&&(a=yield this._encryptionService.decryptWithPIN(r))}if(a)return new o.Wallet(a,this.provider);throw new Error("Failed to unlock wallet")}if(t==="metamask"&&window.ethereum){yield this.switchToAvalancheMainnet();let a=new o.BrowserProvider(window.ethereum);return yield a.send("eth_requestAccounts",[]),yield a.getSigner()}throw new Error("No valid wallet connected. Please sign in with your Agent Wallet or MetaMask.")})}isMetaMaskAccount(){let t=localStorage.getItem("x402_wallet_type");return!!t&&t.trim().toLowerCase()==="metamask"}switchToAvalancheMainnet(){return i(this,null,function*(){let t=window.ethereum;if(t)try{if((yield t.request({method:"eth_chainId"}))===g)return;yield t.request({method:"wallet_switchEthereumChain",params:[{chainId:g}]})}catch(e){if(e.code===4902)yield t.request({method:"wallet_addEthereumChain",params:[{chainId:g,chainName:"Avalanche C-Chain",nativeCurrency:{name:"Avalanche",symbol:"AVAX",decimals:18},rpcUrls:[m.rpcUrl||"https://api.avax.network/ext/bc/C/rpc"],blockExplorerUrls:["https://snowtrace.io/"]}]});else throw e.code===4001?new Error("User rejected the network switch request"):e}})}registerVkaToken(t){return i(this,null,function*(){yield this.ensureVkaTokenMetadata(t)})}ensureVkaTokenMetadata(){return i(this,arguments,function*(t=this.VKA_CONTRACT_ADDRESS){if(!this.isMetaMaskAccount())return;let e=t||this.VKA_CONTRACT_ADDRESS,a=`vka_reg_${e.toLowerCase()}`;if(localStorage.getItem(a)!=="true")try{let r=m.tokenTicker||"VKA",n=18;try{let h=["function symbol() view returns (string)","function decimals() view returns (uint8)"],l=new o.Contract(e,h,this.provider);[r,n]=yield Promise.all([l.symbol(),l.decimals()])}catch{}(yield window.ethereum.request({method:"wallet_watchAsset",params:{type:"ERC20",options:{address:e,symbol:r,decimals:n,image:"https://verifik.app/vka-logo.png"}}}))&&localStorage.setItem(a,"true")}catch{}})}sendTransaction(t,e,a="0x"){return i(this,null,function*(){return(yield this.getSigner()).sendTransaction({to:t,value:o.parseEther(e),data:a})})}payForService(t,e,a,r){return i(this,null,function*(){let n=yield this.getSigner(),c=yield n.getAddress();(yield this.provider.getCode(t))==="0x"&&(t=m.x402PaymentContract);let l=["function payForService(string serviceId, string requestId) public payable"],s=new o.Contract(t,l,n),u=[e,a],d={value:o.parseEther(r)};return{tx:this.isMetaMaskAccount()?yield this._executeMetaMaskTransaction(s,"payForService",u,d):yield this._executeInternalTransaction(s,"payForService",u,d,c),signerAddress:c}})}payForServiceWithToken(t,e,a){return i(this,null,function*(){let r=yield this.getSigner(),n=yield r.getAddress(),c=["function transfer(address to, uint256 amount) public returns (bool)","function decimals() view returns (uint8)"],h=new o.Contract(e,c,this.provider),l=yield h.decimals(),s=o.parseUnits(a,l),u=h.interface.encodeFunctionData("transfer",[t,s]),d;if(this.isMetaMaskAccount())yield this.ensureVkaTokenMetadata(e),d=yield this._executeMetaMaskRaw(e,u,0n);else{let p=new o.Contract(e,c,r);d=yield this._executeInternalTransaction(p,"transfer",[t,s],{},n)}return{tx:d,signerAddress:n}})}submitFeedback(c,h){return i(this,arguments,function*(t,e,a=[],r="",n=null){let l=yield this.getSigner();if(e<1||e>5)throw new Error("Rating must be between 1 and 5");let s=["function submitFeedback(uint256 agentTokenId, uint8 rating, string[] memory tags, string memory comment, bytes32 paymentProof) external returns (uint256)"],u=new o.Contract(m.reputationRegistryContract,s,l),d=n&&o.isHexString(n)?n:o.ZeroHash,p=[t,e,a,r,d];return this.isMetaMaskAccount()?yield this._executeMetaMaskTransaction(u,"submitFeedback",p):yield this._executeInternalTransaction(u,"submitFeedback",p,{},yield l.getAddress())})}_executeMetaMaskRaw(t,e,a=0n){return i(this,null,function*(){let r=window.ethereum;if(!r)throw new Error("MetaMask not found");try{yield this.switchToAvalancheMainnet(),yield this._delay(100);let c=(yield r.request({method:"eth_requestAccounts"}))[0];if(!c)throw new Error("No active account in MetaMask");(yield r.request({method:"eth_chainId"}))!==g&&(yield this.switchToAvalancheMainnet(),yield this._delay(200));let l=this.getAddress();c.toLowerCase()!==l.toLowerCase()&&localStorage.setItem("x402_agent_address",c);let s={from:c,to:t,data:e};a>0n&&(s.value=o.toBeHex(a));let u=yield r.request({method:"eth_sendTransaction",params:[s]});return yield this._delay(500),(yield this.provider.getTransaction(u))||{hash:u,wait:()=>i(this,null,function*(){return this.provider.waitForTransaction(u)})}}catch(n){throw n.code===4001?new Error("Transaction was rejected by user"):n.message?.includes("invalid sender")?new Error("Invalid sender: Please ensure MetaMask is connected to Avalanche. Try reconnecting your wallet."):n.message?.includes("insufficient funds")?new Error("Insufficient funds: Make sure you have enough VKA tokens and AVAX for gas."):n}})}_executeMetaMaskTransaction(n,c,h){return i(this,arguments,function*(t,e,a,r={}){let l=t.interface.encodeFunctionData(e,a),s=r.value||0n;return this._executeMetaMaskRaw(t.target,l,s)})}_executeInternalTransaction(c,h,l){return i(this,arguments,function*(t,e,a,r={},n){let s=yield this._prepareGasOptimizedTransaction(t,e,a,r,n);return yield t[e](...a,s)})}_prepareGasOptimizedTransaction(t,e,a,r,n){return i(this,null,function*(){let c=yield this._estimateGasWithBuffer(t,e,a,r,n);return this._prepareInternalWalletOptions(y(f({},r),{gasLimit:c}),n)})}_estimateGasWithBuffer(t,e,a,r,n){return i(this,null,function*(){try{return(yield t[e].estimateGas(...a,y(f({},r),{from:n})))*120n/100n}catch{return 300000n}})}_prepareInternalWalletOptions(t,e){return i(this,null,function*(){t.from=e;let a=yield this.provider.getFeeData(),r=o.parseUnits(m.priorityFeeTipGwei||"5","gwei");return a.maxFeePerGas&&a.maxPriorityFeePerGas?(t.maxPriorityFeePerGas=a.maxPriorityFeePerGas+r,t.maxFeePerGas=a.maxFeePerGas*125n/100n+r):a.gasPrice&&(t.gasPrice=a.gasPrice*135n/100n),t})}getPaymentHistory(){return i(this,arguments,function*(t=m.x402PaymentContract){let e=this.getAddress();if(!e)return[];let a=["event PaymentReceived(address indexed payer, string serviceId, string requestId, uint256 amount)"],r=new o.Contract(t,a,this.provider),n=r.filters.PaymentReceived(e),c=yield this.provider.getBlockNumber(),h=Math.max(0,c-2e6),l=yield r.queryFilter(n,h);return Promise.all(l.slice().reverse().map(s=>i(this,null,function*(){if("args"in s){let u=yield s.getBlock();return{transactionHash:s.transactionHash,blockNumber:s.blockNumber,timestamp:(u?.timestamp||0)*1e3,serviceId:s.args[1],requestId:s.args[2],amount:o.formatEther(s.args[3])}}return null}))).then(s=>s.filter(u=>u!==null))})}getTransactionDetails(t){return i(this,null,function*(){try{let e=yield this.provider.getTransaction(t);if(!e)return null;let[a,r]=yield Promise.all([this.provider.getTransactionReceipt(t),this.provider.getBlock(e.blockNumber)]);return!a||!r?null:{hash:e.hash,from:e.from,to:e.to,value:o.formatEther(e.value),gasUsed:a.gasUsed.toString(),status:a.status===1?"Success":"Failed",timestamp:r.timestamp*1e3,blockNumber:e.blockNumber}}catch{return null}})}_delay(t){return new Promise(e=>setTimeout(e,t))}static{this.\u0275fac=function(e){return new(e||w)(k(A))}}static{this.\u0275prov=_({token:w,factory:w.\u0275fac,providedIn:"root"})}}return w})();export{F as a};
