import{c as u}from"./chunk-GPCJZ5RP.js";import{d as _}from"./chunk-46LJSX56.js";import{aa as d,g as y,ga as p}from"./chunk-EDXCCCUI.js";import{h as c}from"./chunk-MG3ERZGY.js";var l=class{static isTokenExpired(n,e){if(!n||n===""||n.trim()===""||n.split(".").length!==3)return!0;let t=null;try{t=this._getTokenExpirationDate(n)}catch(r){return console.warn("Failed to decode token:",r),!0}return e=e||0,t===null?!1:!(t.valueOf()>new Date().valueOf()+e*1e3)}static _b64decode(n){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="";if(n=String(n).replace(/=+$/,""),n.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let r=0,a,o,s=0;o=n.charAt(s++);~o&&(a=r%4?a*64+o:o,r++%4)?t+=String.fromCharCode(255&a>>(-2*r&6)):0)o=e.indexOf(o);return t}static _b64DecodeUnicode(n){return decodeURIComponent(Array.prototype.map.call(this._b64decode(n),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(n){let e=n.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:{e+="==";break}case 3:{e+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(e)}static _decodeToken(n){if(!n)return null;let e=n.split(".");if(e.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let t=this._urlBase64Decode(e[1]);if(!t)throw new Error("Cannot decode the token.");return JSON.parse(t)}static _getTokenExpirationDate(n){let e=this._decodeToken(n);if(!e.hasOwnProperty("exp"))return null;let t=new Date(0);return t.setUTCSeconds(e.exp),t}};var x=(()=>{class i{constructor(){this._router=p(_),this._matDialog=p(u),this._isLoggingOut=!1,this._reloadCount=0,this._lastReloadTime=0,this.MAX_RELOADS_PER_MINUTE=3,this.RELOAD_WINDOW_MS=6e4,this._sessionExpired$=new y(!1),this.sessionExpired$=this._sessionExpired$.asObservable(),this.RELOAD_TRACKING_KEY="session_reload_tracking",this._loadReloadTracking()}isTokenValid(){let e=localStorage.getItem("accessToken");if(!e||e.trim()==="")return!1;let t=!l.isTokenExpired(e);return t||console.warn("[SessionService] Token check failed: Token appears expired"),t}hasValidAuthentication(){if(this.isTokenValid())return!0;let e=localStorage.getItem("x402_agent_address"),t=localStorage.getItem("x402_wallet_type"),r=!!localStorage.getItem("x402_agent_pk_encrypted"),a=!!localStorage.getItem("x402_agent_pk");return!!(e&&(t==="metamask"||r||a))}handleSessionExpired(e={}){if(this._isLoggingOut){console.warn("[SessionService] Already handling session expiration, skipping...");return}this._isLoggingOut=!0,console.log("[SessionService] Handling session expiration",e),this._clearWeb2Credentials(),e.clearWeb2Only||this._clearWeb3Credentials(),this._sessionExpired$.next(!0),this._matDialog.closeAll(),setTimeout(()=>{this._isLoggingOut=!1},1e3),e.silent||this._router.navigate(["/"])}_clearWeb2Credentials(){localStorage.removeItem("accessToken"),localStorage.removeItem("verifik_account"),localStorage.removeItem("user"),localStorage.removeItem("currentConversationId")}_clearWeb3Credentials(){localStorage.removeItem("x402_agent_address"),localStorage.removeItem("x402_agent_pk"),localStorage.removeItem("x402_agent_pk_encrypted"),localStorage.removeItem("x402_wallet_type"),localStorage.removeItem("x402_encryption_method"),localStorage.removeItem("x402_encryption_salt"),localStorage.removeItem("x402_credential_id"),localStorage.removeItem("lastWalletAddress")}clearAllSessionData(){this._clearWeb2Credentials(),this._clearWeb3Credentials(),localStorage.removeItem(this.RELOAD_TRACKING_KEY)}safeReload(){let e=Date.now();return e-this._lastReloadTime<this.RELOAD_WINDOW_MS?this._reloadCount++:this._reloadCount=1,this._lastReloadTime=e,this._saveReloadTracking(),this._reloadCount>this.MAX_RELOADS_PER_MINUTE?(console.error("[SessionService] Reload loop detected! Stopping reload and clearing session."),this.clearAllSessionData(),this._router.navigate(["/"]),!1):(location.reload(),!0)}_loadReloadTracking(){try{let e=localStorage.getItem(this.RELOAD_TRACKING_KEY);if(e){let t=JSON.parse(e);Date.now()-t.lastReloadTime<this.RELOAD_WINDOW_MS?(this._reloadCount=t.reloadCount,this._lastReloadTime=t.lastReloadTime,this._reloadCount>this.MAX_RELOADS_PER_MINUTE&&(console.error("[SessionService] Reload loop detected on init! Clearing session."),this.clearAllSessionData())):localStorage.removeItem(this.RELOAD_TRACKING_KEY)}}catch(e){console.warn("[SessionService] Failed to load reload tracking",e),localStorage.removeItem(this.RELOAD_TRACKING_KEY)}}_saveReloadTracking(){try{localStorage.setItem(this.RELOAD_TRACKING_KEY,JSON.stringify({reloadCount:this._reloadCount,lastReloadTime:this._lastReloadTime}))}catch(e){console.warn("[SessionService] Failed to save reload tracking",e)}}resetReloadTracking(){this._reloadCount=0,this._lastReloadTime=0,localStorage.removeItem(this.RELOAD_TRACKING_KEY)}isTokenExpiringSoon(e=300){let t=localStorage.getItem("accessToken");return t?l.isTokenExpired(t,-e):!1}getTokenExpirationTime(){let e=localStorage.getItem("accessToken");if(!e||e.trim()==="")return-1;try{let t=e.split(".");if(t.length!==3)return-1;let r=JSON.parse(atob(t[1]));if(!r.exp)return-1;let a=r.exp*1e3,o=Date.now();return a<=o?-1:a-o}catch{return-1}}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var v=(()=>{class i{constructor(){this.STORAGE_KEY_ENCRYPTED_PK="x402_agent_pk_encrypted",this.STORAGE_KEY_ENCRYPTION_METHOD="x402_encryption_method",this.STORAGE_KEY_SALT="x402_encryption_salt"}isPasskeysSupported(){return c(this,null,function*(){return window.PublicKeyCredential!==void 0&&typeof window.PublicKeyCredential=="function"})}encryptWithPasskeys(e){return c(this,null,function*(){try{let r={challenge:crypto.getRandomValues(new Uint8Array(32)),rp:{name:"Smart Agent",id:window.location.hostname},user:{id:crypto.getRandomValues(new Uint8Array(16)),name:"agent-wallet",displayName:"Agent Wallet"},pubKeyCredParams:[{alg:-7,type:"public-key"},{alg:-257,type:"public-key"}],authenticatorSelection:{authenticatorAttachment:"platform",requireResidentKey:!1,userVerification:"required"},timeout:6e4,attestation:"none"},a=yield navigator.credentials.create({publicKey:r});if(!a)throw new Error("Failed to create credential");let o=new Uint8Array(a.rawId),s=yield this.deriveKeyFromCredential(o),h=yield this.encryptData(e,s);return localStorage.setItem(this.STORAGE_KEY_ENCRYPTED_PK,JSON.stringify(h)),localStorage.setItem(this.STORAGE_KEY_ENCRYPTION_METHOD,"passkey"),localStorage.setItem("x402_credential_id",this.arrayBufferToBase64(o)),localStorage.removeItem("x402_agent_pk"),!0}catch(t){return console.error("Passkey encryption failed:",t),!1}})}decryptWithPasskeys(){return c(this,null,function*(){try{let e=localStorage.getItem(this.STORAGE_KEY_ENCRYPTED_PK),t=localStorage.getItem("x402_credential_id");if(!e||!t)throw new Error("No encrypted data found");let r=JSON.parse(e),a=this.base64ToArrayBuffer(t),s={challenge:crypto.getRandomValues(new Uint8Array(32)),allowCredentials:[{id:a,type:"public-key",transports:["internal"]}],timeout:6e4,userVerification:"required"};if(!(yield navigator.credentials.get({publicKey:s})))throw new Error("Authentication failed");let g=yield this.deriveKeyFromCredential(new Uint8Array(a));return yield this.decryptData(r,g)}catch(e){return console.error("Passkey decryption failed:",e),null}})}encryptWithPIN(e,t){return c(this,null,function*(){try{if(!/^\d{6}$/.test(t))throw new Error("PIN must be 6 digits");let r=crypto.getRandomValues(new Uint8Array(16)),a=yield this.deriveKeyFromPIN(t,r),o=yield this.encryptData(e,a);return localStorage.setItem(this.STORAGE_KEY_ENCRYPTED_PK,JSON.stringify(o)),localStorage.setItem(this.STORAGE_KEY_ENCRYPTION_METHOD,"pin"),localStorage.setItem(this.STORAGE_KEY_SALT,this.arrayBufferToBase64(r)),localStorage.removeItem("x402_agent_pk"),!0}catch(r){return console.error("PIN encryption failed:",r),!1}})}decryptWithPIN(e){return c(this,null,function*(){try{let t=localStorage.getItem(this.STORAGE_KEY_ENCRYPTED_PK),r=localStorage.getItem(this.STORAGE_KEY_SALT);if(!t||!r)throw new Error("No encrypted data found");let a=JSON.parse(t),o=this.base64ToArrayBuffer(r),s=yield this.deriveKeyFromPIN(e,new Uint8Array(o));return yield this.decryptData(a,s)}catch(t){return console.error("PIN decryption failed:",t),null}})}getEncryptionMethod(){return localStorage.getItem(this.STORAGE_KEY_ENCRYPTION_METHOD)}isWalletEncrypted(){return!!localStorage.getItem(this.STORAGE_KEY_ENCRYPTED_PK)}deriveKeyFromCredential(e){return c(this,null,function*(){let t=yield crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return yield crypto.subtle.deriveKey({name:"PBKDF2",salt:new Uint8Array([115,109,97,114,116,45,97,103,101,110,116,45,119,97,108,108]),iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])})}deriveKeyFromPIN(e,t){return c(this,null,function*(){let a=new TextEncoder().encode(e),o=yield crypto.subtle.importKey("raw",a,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return yield crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])})}encryptData(e,t){return c(this,null,function*(){let a=new TextEncoder().encode(e),o=crypto.getRandomValues(new Uint8Array(12)),s=yield crypto.subtle.encrypt({name:"AES-GCM",iv:o},t,a);return{iv:this.arrayBufferToBase64(o),ciphertext:this.arrayBufferToBase64(new Uint8Array(s))}})}decryptData(e,t){return c(this,null,function*(){let r=this.base64ToArrayBuffer(e.iv),a=this.base64ToArrayBuffer(e.ciphertext),o=yield crypto.subtle.decrypt({name:"AES-GCM",iv:r},t,a);return new TextDecoder().decode(o)})}arrayBufferToBase64(e){let t=new Uint8Array(e),r="";for(let a=0;a<t.byteLength;a++)r+=String.fromCharCode(t[a]);return btoa(r)}base64ToArrayBuffer(e){let t=atob(e),r=new Uint8Array(t.length);for(let a=0;a<t.length;a++)r[a]=t.charCodeAt(a);return r.buffer}clearEncryptionData(){localStorage.removeItem(this.STORAGE_KEY_ENCRYPTED_PK),localStorage.removeItem(this.STORAGE_KEY_ENCRYPTION_METHOD),localStorage.removeItem(this.STORAGE_KEY_SALT),localStorage.removeItem("x402_credential_id"),localStorage.removeItem("x402_agent_pk")}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{l as a,x as b,v as c};
