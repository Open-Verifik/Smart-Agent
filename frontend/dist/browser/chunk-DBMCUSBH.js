import{b as S,c as A}from"./chunk-KZT4A4EA.js";import{r as s}from"./chunk-E62Z5BTR.js";import{k as w}from"./chunk-VAUREE24.js";import{_,da as b,ea as k,g as y}from"./chunk-UEB47KKL.js";import{a as f,b as v,g as i}from"./chunk-GAL4ENT6.js";var g="0xa86a",B=(()=>{class p{constructor(t){this._encryptionService=t,this.balanceSubject=new y("0.00"),this.balance$=this.balanceSubject.asObservable(),this.tokenBalanceSubject=new y("0.00"),this.tokenBalance$=this.tokenBalanceSubject.asObservable(),this.RPC_URL=w.rpcUrl||"https://api.avax.network/ext/bc/C/rpc",this.VKA_CONTRACT_ADDRESS=w.vkaContractAddress,this._sessionService=k(S),this.provider=new s.providers.JsonRpcProvider(this.RPC_URL),this.provider.pollingInterval=36e5,window.ethereum&&window.ethereum.on("accountsChanged",e=>{localStorage.getItem("x402_wallet_type")==="metamask"&&(e.length>0&&localStorage.setItem("x402_agent_address",e[0]),this._sessionService.safeReload())})}startActivePolling(){this.provider.pollingInterval=1500}pausePolling(){this.provider.pollingInterval=36e5}getAddress(){return localStorage.getItem("x402_agent_address")||""}getBalance(){return i(this,null,function*(){let t=this.getAddress();if(!t)return"0.00";let e=yield this.provider.getBalance(t);return s.utils.formatEther(e)})}getTokenBalance(){return i(this,arguments,function*(t=this.VKA_CONTRACT_ADDRESS){let e=this.getAddress();if(!e)return"0.00";try{let a=["function balanceOf(address) view returns (uint256)","function decimals() view returns (uint8)"],r=new s.Contract(t,a,this.provider),[n,o]=yield Promise.all([r.balanceOf(e),r.decimals()]);return s.utils.formatUnits(n,o)}catch{return"0.00"}})}refreshBalance(){return i(this,null,function*(){try{this.balanceSubject.next(yield this.getBalance()),this.tokenBalanceSubject.next(yield this.getTokenBalance())}catch{}})}resetWallet(){this._encryptionService.clearEncryptionData(),localStorage.removeItem("x402_agent_address"),localStorage.removeItem("x402_wallet_type"),this._sessionService.safeReload()}getSigner(){return i(this,null,function*(){let t=localStorage.getItem("x402_wallet_type"),e=this._encryptionService.getEncryptionMethod();if(!e&&this._encryptionService.isWalletEncrypted()&&(e=localStorage.getItem("x402_credential_id")?"passkey":localStorage.getItem("x402_encryption_salt")?"pin":null),e){let a=null;if(e==="passkey")a=yield this._encryptionService.decryptWithPasskeys();else if(e==="pin"){let r=prompt("Please enter your 6-digit PIN to sign the transaction:");r&&(a=yield this._encryptionService.decryptWithPIN(r))}if(a)return new s.Wallet(a,this.provider);throw new Error("Failed to unlock wallet")}if(t==="metamask"&&window.ethereum){yield this.switchToAvalancheMainnet();let a=new s.providers.Web3Provider(window.ethereum);return yield a.send("eth_requestAccounts",[]),a.getSigner()}throw new Error("No valid wallet connected. Please sign in with your Agent Wallet or MetaMask.")})}isMetaMaskAccount(){let t=localStorage.getItem("x402_wallet_type");return!!t&&t.trim().toLowerCase()==="metamask"}switchToAvalancheMainnet(){return i(this,null,function*(){let t=window.ethereum;if(t)try{if((yield t.request({method:"eth_chainId"}))===g)return;yield t.request({method:"wallet_switchEthereumChain",params:[{chainId:g}]})}catch(e){if(e.code===4902)yield t.request({method:"wallet_addEthereumChain",params:[{chainId:g,chainName:"Avalanche C-Chain",nativeCurrency:{name:"Avalanche",symbol:"AVAX",decimals:18},rpcUrls:[w.rpcUrl||"https://api.avax.network/ext/bc/C/rpc"],blockExplorerUrls:["https://snowtrace.io/"]}]});else throw e.code===4001?new Error("User rejected the network switch request"):e}})}registerVkaToken(t){return i(this,null,function*(){yield this.ensureVkaTokenMetadata(t)})}ensureVkaTokenMetadata(){return i(this,arguments,function*(t=this.VKA_CONTRACT_ADDRESS){if(!this.isMetaMaskAccount())return;let e=t||this.VKA_CONTRACT_ADDRESS,a=`vka_reg_${e.toLowerCase()}`;if(localStorage.getItem(a)!=="true")try{let r=w.tokenTicker||"VKA",n=18;try{let u=["function symbol() view returns (string)","function decimals() view returns (uint8)"],c=new s.Contract(e,u,this.provider);[r,n]=yield Promise.all([c.symbol(),c.decimals()])}catch{}(yield window.ethereum.request({method:"wallet_watchAsset",params:{type:"ERC20",options:{address:e,symbol:r,decimals:n,image:"https://verifik.app/vka-logo.png"}}}))&&localStorage.setItem(a,"true")}catch{}})}sendTransaction(t,e,a="0x"){return i(this,null,function*(){return(yield this.getSigner()).sendTransaction({to:t,value:s.utils.parseEther(e),data:a})})}payForService(t,e,a,r){return i(this,null,function*(){let n=yield this.getSigner(),o=yield n.getAddress();(yield this.provider.getCode(t))==="0x"&&(t=w.x402PaymentContract);let c=["function payForService(string serviceId, string requestId) public payable"],l=new s.Contract(t,c,n),d=[e,a],h={value:s.utils.parseEther(r)};return{tx:this.isMetaMaskAccount()?yield this._executeMetaMaskTransaction(l,"payForService",d,h):yield this._executeInternalTransaction(l,"payForService",d,h,o),signerAddress:o}})}payForServiceWithToken(t,e,a){return i(this,null,function*(){let r=yield this.getSigner(),n=yield r.getAddress(),o=["function transfer(address to, uint256 amount) public returns (bool)","function decimals() view returns (uint8)"],u=new s.Contract(e,o,this.provider),c=yield u.decimals(),l=s.utils.parseUnits(a,c),d=u.interface.encodeFunctionData("transfer",[t,l]),h;if(this.isMetaMaskAccount())yield this.ensureVkaTokenMetadata(e),h=yield this._executeMetaMaskRaw(e,d,s.BigNumber.from(0));else{let m=new s.Contract(e,o,r);h=yield this._executeInternalTransaction(m,"transfer",[t,l],{},n)}return{tx:h,signerAddress:n}})}submitFeedback(o,u){return i(this,arguments,function*(t,e,a=[],r="",n=null){let c=yield this.getSigner();if(e<1||e>5)throw new Error("Rating must be between 1 and 5");let l=["function submitFeedback(uint256 agentTokenId, uint8 rating, string[] memory tags, string memory comment, bytes32 paymentProof) external returns (uint256)"],d=new s.Contract(w.reputationRegistryContract,l,c),h=n&&s.utils.isHexString(n)?n:s.constants.HashZero,m=[t,e,a,r,h];return this.isMetaMaskAccount()?yield this._executeMetaMaskTransaction(d,"submitFeedback",m):yield this._executeInternalTransaction(d,"submitFeedback",m,{},yield c.getAddress())})}_executeMetaMaskRaw(r,n){return i(this,arguments,function*(t,e,a=s.BigNumber.from(0)){let o=window.ethereum;if(!o)throw new Error("MetaMask not found");try{yield this.switchToAvalancheMainnet(),yield this._delay(100);let c=(yield o.request({method:"eth_requestAccounts"}))[0];if(!c)throw new Error("No active account in MetaMask");(yield o.request({method:"eth_chainId"}))!==g&&(yield this.switchToAvalancheMainnet(),yield this._delay(200));let d=this.getAddress();c.toLowerCase()!==d.toLowerCase()&&localStorage.setItem("x402_agent_address",c);let h={from:c,to:t,data:e};a.isZero()||(h.value=a.toHexString());let m=yield o.request({method:"eth_sendTransaction",params:[h]});return yield this._delay(500),(yield this.provider.getTransaction(m))||{hash:m,wait:()=>i(this,null,function*(){return this.provider.waitForTransaction(m)})}}catch(u){throw u.code===4001?new Error("Transaction was rejected by user"):u.message?.includes("invalid sender")?new Error("Invalid sender: Please ensure MetaMask is connected to Avalanche. Try reconnecting your wallet."):u.message?.includes("insufficient funds")?new Error("Insufficient funds: Make sure you have enough VKA tokens and AVAX for gas."):u}})}_executeMetaMaskTransaction(n,o,u){return i(this,arguments,function*(t,e,a,r={}){let c=t.interface.encodeFunctionData(e,a),l=r.value||s.BigNumber.from(0);return this._executeMetaMaskRaw(t.address,c,l)})}_executeInternalTransaction(o,u,c){return i(this,arguments,function*(t,e,a,r={},n){let l=yield this._prepareGasOptimizedTransaction(t,e,a,r,n);return yield t[e](...a,l)})}_prepareGasOptimizedTransaction(t,e,a,r,n){return i(this,null,function*(){let o=yield this._estimateGasWithBuffer(t,e,a,r,n);return this._prepareInternalWalletOptions(v(f({},r),{gasLimit:o}),n)})}_estimateGasWithBuffer(t,e,a,r,n){return i(this,null,function*(){try{return(yield t.estimateGas[e](...a,v(f({},r),{from:n}))).mul(120).div(100)}catch{return s.BigNumber.from(3e5)}})}_prepareInternalWalletOptions(t,e){return i(this,null,function*(){t.from=e;let a=yield this.provider.getFeeData(),r=s.utils.parseUnits(w.priorityFeeTipGwei||"5","gwei");return a.maxFeePerGas&&a.maxPriorityFeePerGas?(t.maxPriorityFeePerGas=a.maxPriorityFeePerGas.add(r),t.maxFeePerGas=a.maxFeePerGas.mul(125).div(100).add(r)):a.gasPrice&&(t.gasPrice=a.gasPrice.mul(135).div(100)),t})}getPaymentHistory(){return i(this,arguments,function*(t=w.x402PaymentContract){let e=this.getAddress();if(!e)return[];let a=["event PaymentReceived(address indexed payer, string serviceId, string requestId, uint256 amount)"],r=new s.Contract(t,a,this.provider),n=r.filters.PaymentReceived(e),o=yield this.provider.getBlockNumber(),u=Math.max(0,o-2e6),c=yield r.queryFilter(n,u);return Promise.all(c.slice().reverse().map(l=>i(this,null,function*(){let d=r.interface.parseLog(l),h=yield l.getBlock();return{transactionHash:l.transactionHash,blockNumber:l.blockNumber,timestamp:h.timestamp*1e3,serviceId:d.args.serviceId,requestId:d.args.requestId,amount:s.utils.formatEther(d.args.amount)}})))})}getTransactionDetails(t){return i(this,null,function*(){try{let e=yield this.provider.getTransaction(t);if(!e)return null;let[a,r]=yield Promise.all([this.provider.getTransactionReceipt(t),this.provider.getBlock(e.blockNumber)]);return{hash:e.hash,from:e.from,to:e.to,value:s.utils.formatEther(e.value),gasUsed:a.gasUsed.toString(),status:a.status===1?"Success":"Failed",timestamp:r.timestamp*1e3,blockNumber:e.blockNumber}}catch{return null}})}_delay(t){return new Promise(e=>setTimeout(e,t))}static{this.\u0275fac=function(e){return new(e||p)(b(A))}}static{this.\u0275prov=_({token:p,factory:p.\u0275fac,providedIn:"root"})}}return p})();export{B as a};
