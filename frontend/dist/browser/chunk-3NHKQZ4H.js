import{a as y}from"./chunk-XRBOLGPP.js";import{c as h}from"./chunk-BJAZCYPM.js";import{d as p}from"./chunk-QIQIZ3Q6.js";import{aa as l,g as _,ga as d}from"./chunk-BMVGBJ55.js";import{i}from"./chunk-66YHNWRR.js";var R=(()=>{class n{constructor(){this._router=d(p),this._matDialog=d(h),this._isLoggingOut=!1,this._reloadCount=0,this._lastReloadTime=0,this.MAX_RELOADS_PER_MINUTE=3,this.RELOAD_WINDOW_MS=6e4,this._sessionExpired$=new _(!1),this.sessionExpired$=this._sessionExpired$.asObservable(),this.RELOAD_TRACKING_KEY="session_reload_tracking",this._loadReloadTracking()}isTokenValid(){let e=localStorage.getItem("accessToken");if(!e||e.trim()==="")return!1;let t=!y.isTokenExpired(e);return t||console.warn("[SessionService] Token check failed: Token appears expired"),t}hasValidAuthentication(){if(this.isTokenValid())return!0;let e=localStorage.getItem("x402_agent_address"),t=localStorage.getItem("x402_wallet_type"),a=!!localStorage.getItem("x402_agent_pk_encrypted"),r=!!localStorage.getItem("x402_agent_pk");return!!(e&&(t==="metamask"||a||r))}handleSessionExpired(e={}){if(this._isLoggingOut){console.warn("[SessionService] Already handling session expiration, skipping...");return}this._isLoggingOut=!0,console.log("[SessionService] Handling session expiration",e),this._clearWeb2Credentials(),e.clearWeb2Only||this._clearWeb3Credentials(),this._sessionExpired$.next(!0),this._matDialog.closeAll(),setTimeout(()=>{this._isLoggingOut=!1},1e3),e.silent||this._router.navigate(["/"])}_clearWeb2Credentials(){localStorage.removeItem("accessToken"),localStorage.removeItem("verifik_account"),localStorage.removeItem("user"),localStorage.removeItem("currentConversationId")}_clearWeb3Credentials(){localStorage.removeItem("x402_agent_address"),localStorage.removeItem("x402_agent_pk"),localStorage.removeItem("x402_agent_pk_encrypted"),localStorage.removeItem("x402_wallet_type"),localStorage.removeItem("x402_encryption_method"),localStorage.removeItem("x402_encryption_salt"),localStorage.removeItem("x402_credential_id"),localStorage.removeItem("lastWalletAddress")}clearAllSessionData(){this._clearWeb2Credentials(),this._clearWeb3Credentials(),localStorage.removeItem(this.RELOAD_TRACKING_KEY)}safeReload(){let e=Date.now();return e-this._lastReloadTime<this.RELOAD_WINDOW_MS?this._reloadCount++:this._reloadCount=1,this._lastReloadTime=e,this._saveReloadTracking(),this._reloadCount>this.MAX_RELOADS_PER_MINUTE?(console.error("[SessionService] Reload loop detected! Stopping reload and clearing session."),this.clearAllSessionData(),this._router.navigate(["/"]),!1):(location.reload(),!0)}_loadReloadTracking(){try{let e=localStorage.getItem(this.RELOAD_TRACKING_KEY);if(e){let t=JSON.parse(e);Date.now()-t.lastReloadTime<this.RELOAD_WINDOW_MS?(this._reloadCount=t.reloadCount,this._lastReloadTime=t.lastReloadTime,this._reloadCount>this.MAX_RELOADS_PER_MINUTE&&(console.error("[SessionService] Reload loop detected on init! Clearing session."),this.clearAllSessionData())):localStorage.removeItem(this.RELOAD_TRACKING_KEY)}}catch(e){console.warn("[SessionService] Failed to load reload tracking",e),localStorage.removeItem(this.RELOAD_TRACKING_KEY)}}_saveReloadTracking(){try{localStorage.setItem(this.RELOAD_TRACKING_KEY,JSON.stringify({reloadCount:this._reloadCount,lastReloadTime:this._lastReloadTime}))}catch(e){console.warn("[SessionService] Failed to save reload tracking",e)}}resetReloadTracking(){this._reloadCount=0,this._lastReloadTime=0,localStorage.removeItem(this.RELOAD_TRACKING_KEY)}isTokenExpiringSoon(e=300){let t=localStorage.getItem("accessToken");return t?y.isTokenExpired(t,-e):!1}getTokenExpirationTime(){let e=localStorage.getItem("accessToken");if(!e||e.trim()==="")return-1;try{let t=e.split(".");if(t.length!==3)return-1;let a=JSON.parse(atob(t[1]));if(!a.exp)return-1;let r=a.exp*1e3,o=Date.now();return r<=o?-1:r-o}catch{return-1}}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var K=(()=>{class n{constructor(){this.STORAGE_KEY_ENCRYPTED_PK="x402_agent_pk_encrypted",this.STORAGE_KEY_ENCRYPTION_METHOD="x402_encryption_method",this.STORAGE_KEY_SALT="x402_encryption_salt"}isPasskeysSupported(){return i(this,null,function*(){return window.PublicKeyCredential!==void 0&&typeof window.PublicKeyCredential=="function"})}encryptWithPasskeys(e){return i(this,null,function*(){try{let a={challenge:crypto.getRandomValues(new Uint8Array(32)),rp:{name:"Smart Agent",id:window.location.hostname},user:{id:crypto.getRandomValues(new Uint8Array(16)),name:"agent-wallet",displayName:"Agent Wallet"},pubKeyCredParams:[{alg:-7,type:"public-key"},{alg:-257,type:"public-key"}],authenticatorSelection:{authenticatorAttachment:"platform",requireResidentKey:!1,userVerification:"required"},timeout:6e4,attestation:"none"},r=yield navigator.credentials.create({publicKey:a});if(!r)throw new Error("Failed to create credential");let o=new Uint8Array(r.rawId),s=yield this.deriveKeyFromCredential(o),c=yield this.encryptData(e,s);return localStorage.setItem(this.STORAGE_KEY_ENCRYPTED_PK,JSON.stringify(c)),localStorage.setItem(this.STORAGE_KEY_ENCRYPTION_METHOD,"passkey"),localStorage.setItem("x402_credential_id",this.arrayBufferToBase64(o)),localStorage.removeItem("x402_agent_pk"),!0}catch(t){return console.error("Passkey encryption failed:",t),!1}})}decryptWithPasskeys(){return i(this,null,function*(){try{let e=localStorage.getItem(this.STORAGE_KEY_ENCRYPTED_PK),t=localStorage.getItem("x402_credential_id");if(!e||!t)throw new Error("No encrypted data found");let a=JSON.parse(e),r=this.base64ToArrayBuffer(t),s={challenge:crypto.getRandomValues(new Uint8Array(32)),allowCredentials:[{id:r,type:"public-key",transports:["internal"]}],timeout:6e4,userVerification:"required"};if(!(yield navigator.credentials.get({publicKey:s})))throw new Error("Authentication failed");let m=yield this.deriveKeyFromCredential(new Uint8Array(r));return yield this.decryptData(a,m)}catch(e){return console.error("Passkey decryption failed:",e),null}})}encryptWithPIN(e,t){return i(this,null,function*(){try{if(!/^\d{6}$/.test(t))throw new Error("PIN must be 6 digits");let a=crypto.getRandomValues(new Uint8Array(16)),r=yield this.deriveKeyFromPIN(t,a),o=yield this.encryptData(e,r);return localStorage.setItem(this.STORAGE_KEY_ENCRYPTED_PK,JSON.stringify(o)),localStorage.setItem(this.STORAGE_KEY_ENCRYPTION_METHOD,"pin"),localStorage.setItem(this.STORAGE_KEY_SALT,this.arrayBufferToBase64(a)),localStorage.removeItem("x402_agent_pk"),!0}catch(a){return console.error("PIN encryption failed:",a),!1}})}decryptWithPIN(e){return i(this,null,function*(){try{let t=localStorage.getItem(this.STORAGE_KEY_ENCRYPTED_PK),a=localStorage.getItem(this.STORAGE_KEY_SALT);if(!t||!a)throw new Error("No encrypted data found");let r=JSON.parse(t),o=this.base64ToArrayBuffer(a),s=yield this.deriveKeyFromPIN(e,new Uint8Array(o));return yield this.decryptData(r,s)}catch(t){return console.error("PIN decryption failed:",t),null}})}getEncryptionMethod(){return localStorage.getItem(this.STORAGE_KEY_ENCRYPTION_METHOD)}isWalletEncrypted(){return!!localStorage.getItem(this.STORAGE_KEY_ENCRYPTED_PK)}deriveKeyFromCredential(e){return i(this,null,function*(){let t=yield crypto.subtle.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return yield crypto.subtle.deriveKey({name:"PBKDF2",salt:new Uint8Array([115,109,97,114,116,45,97,103,101,110,116,45,119,97,108,108]),iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])})}deriveKeyFromPIN(e,t){return i(this,null,function*(){let r=new TextEncoder().encode(e),o=yield crypto.subtle.importKey("raw",r,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return yield crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])})}encryptData(e,t){return i(this,null,function*(){let r=new TextEncoder().encode(e),o=crypto.getRandomValues(new Uint8Array(12)),s=yield crypto.subtle.encrypt({name:"AES-GCM",iv:o},t,r);return{iv:this.arrayBufferToBase64(o),ciphertext:this.arrayBufferToBase64(new Uint8Array(s))}})}decryptData(e,t){return i(this,null,function*(){let a=this.base64ToArrayBuffer(e.iv),r=this.base64ToArrayBuffer(e.ciphertext),o=yield crypto.subtle.decrypt({name:"AES-GCM",iv:a},t,r);return new TextDecoder().decode(o)})}arrayBufferToBase64(e){let t=new Uint8Array(e),a="";for(let r=0;r<t.byteLength;r++)a+=String.fromCharCode(t[r]);return btoa(a)}base64ToArrayBuffer(e){let t=atob(e),a=new Uint8Array(t.length);for(let r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return a.buffer}clearEncryptionData(){localStorage.removeItem(this.STORAGE_KEY_ENCRYPTED_PK),localStorage.removeItem(this.STORAGE_KEY_ENCRYPTION_METHOD),localStorage.removeItem(this.STORAGE_KEY_SALT),localStorage.removeItem("x402_credential_id"),localStorage.removeItem("x402_agent_pk")}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{R as a,K as b};
